import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, onSnapshot, query, updateDoc, arrayUnion, arrayRemove, deleteDoc, getDocs } from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { ChevronDown, ChevronRight, X, FileText, File, BookOpen, Layers, ListTodo } from 'lucide-react'; // Added icons

// Define global variables for Firebase configuration (provided by the environment)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-rbi-app';

function App() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [storage, setStorage] = useState(null);
    const [userId, setUserId] = useState(null);
    const [loading, setLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [studyPlans, setStudyPlans] = useState([]);
    const [newPlanName, setNewPlanName] = useState('');
    // FIX: Correctly initialize selectedPlan with useState
    const [selectedPlan, setSelectedPlan] = useState(null); 
    const [newTaskContent, setNewTaskContent] = useState('');
    const [newNoteContent, setNewNoteContent] = useState('');
    const [notes, setNotes] = useState([]);
    const [quizQuestion, setQuizQuestion] = useState('');
    const [quizOptions, setQuizOptions] = []; // This line was problematic
    const [quizAnswer, setQuizAnswer] = useState('');
    const [selectedQuizOption, setSelectedQuizOption] = useState('');
    const [quizFeedback, setQuizFeedback] = useState('');
    const [selectedQuizSubject, setSelectedQuizSubject] = useState('');
    const [quizResults, setQuizResults] = useState([]);
    const [llmQuestion, setLlmQuestion] = useState('');
    const [llmAnswer, setLlmAnswer] = useState('');
    const [llmLoading, setLlmLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [showMessage, setShowMessage] = useState(false);
    const [essayInput, setEssayInput] = useState('');
    const [essayFeedback, setEssayFeedback] = useState('');
    const [essayLoading, setEssayLoading] = useState(false);
    const [planEnhancementFeedback, setPlanEnhancementFeedback] = useState('');
    const [planEnhancementLoading, setPlanEnhancementLoading] = useState(false);
    const [selectedNotePhase, setSelectedNotePhase] = useState('');
    const [selectedNoteSubject, setSelectedNoteSubject] = useState('');
    const [selectedNoteChapter, setSelectedNoteChapter] = useState('');
    const [currentAffairsDateInput, setCurrentAffairsDateInput] = useState('');
    const [noteTitle, setNoteTitle] = useState('');

    const [selectedFile, setSelectedFile] = useState(null);
    const [showStorageRulesMessage, setShowStorageRulesMessage] = useState(false);
    const [showNoteModal, setShowNoteModal] = useState(false);
    const [currentViewingNote, setCurrentViewingNote] = null; // This line was problematic
    const [chapterProgress, setChapterProgress] = useState({}); // Renamed from completedChapters

    // State for hierarchical note view
    const [noteViewLevel, setNoteViewLevel] = useState('phases'); // 'phases', 'subjects', 'chapters', 'notesList'
    const [currentNotePhase, setCurrentNotePhase] = useState(null);
    const [currentNoteSubject, setCurrentNoteSubject] = useState(null);
    const [currentNoteChapter, setCurrentNoteChapter] = useState(null);

    // State for "Add Note" modal/form
    const [showAddNoteModal, setShowAddNoteModal] = useState(false);

    // State for Quiz view level
    const [quizViewLevel, setQuizViewLevel] = useState('phases'); // 'phases', 'subjects', 'chapters', 'quizForm'
    const [currentQuizPhase, setCurrentQuizPhase] = useState(null);
    // FIX: Correctly initialize currentQuizSubject with useState
    const [currentQuizSubject, setCurrentQuizSubject] = useState(null);
    const [currentQuizChapter, setCurrentQuizChapter] = useState(null);

    // New state for "Take Test" functionality
    const [generatedTestQuestions, setGeneratedTestQuestions] = useState([]);
    const [isTestLoading, setIsTestLoading] = useState(false);
    const [currentTestChapter, setCurrentTestChapter] = useState(null);
    const [currentTestSubject, setCurrentTestSubject] = useState(null);
    const [currentTestPhase, setCurrentTestPhase] = useState(null);
    const [testAnswers, setTestAnswers] = useState({});
    const [testResults, setTestResults] = useState(null);


    const [expandedItems, setExpandedItems] = useState({});

    const [filterPhase, setFilterPhase] = useState('');
    const [filterSubject, setFilterSubject] = useState('');
    const [filterChapter, setFilterChapter] = useState('');
    const [searchTerm, setSearchTerm] = useState('');

    const [dailyNews, setDailyNews] = useState([]);
    const [showAddNewsModal, setShowAddNewsModal] = useState(false);
    const [newNewsDate, setNewNewsDate] = useState('');
    const [newNewsSummary, setNewNewsSummary] = useState('');
    const [newsPhase, setNewsPhase] = useState('');
    const [newsSubject, setNewNewsSubject] = useState('');
    const [newsChapter, setNewNewsChapter] = useState('');
    const [currentViewingNewsItem, setCurrentViewingNewsItem] = useState(null);
    const [showNewsDetailModal, setShowNewsDetailModal] = useState(false);


    const toggleItem = (path) => {
        setExpandedItems(prev => ({ ...prev, [path]: !prev[path] }));
    };

    const toggleSyllabusPhase = (phaseKey) => {
        setExpandedItems(prev => ({ ...prev, [`syllabus-${phaseKey}`]: !prev[phaseKey] }));
    };
    const toggleSyllabusSubject = (phaseKey, subjectName) => {
        setExpandedItems(prev => ({ ...prev, [`syllabus-${phaseKey}-${subjectName}`]: !prev[`syllabus-${phaseKey}-${subjectName}`] }));
    };


    const showMessageModal = (msg) => {
        setMessage(msg);
        setShowMessage(true);
        setTimeout(() => {
            setShowMessage(false);
            setMessage('');
        }, 3000);
    };

    const rbiSyllabus = {
        "Phase I": {
            title: "Phase I (Prelims)",
            sections: [
                {
                    name: "General Awareness",
                    topics: [
                        "Current Affairs (Date-wise)",
                        "Indian Financial System",
                        "Indian Banking System",
                        "Monetary Plans",
                        "National Institutions",
                        "Banking Terms",
                        "Static GK (History, Geography, Polity, Science, etc.)"
                    ]
                },
                {
                    name: "Quantitative Aptitude",
                    topics: [
                        "Data Interpretation (Tables, Graphs, Caselets)",
                        "Number Series",
                        "Simplification & Approximation",
                        "Quadratic Equations",
                        "Profit & Loss",
                        "Simple & Compound Interest",
                        "Time & Work",
                        "Time, Speed & Distance",
                        "Ratio & Proportion",
                        "Percentage",
                        "Average",
                        "Mensuration",
                        "Permutation & Combination",
                        "Probability"
                    ]
                },
                {
                    name: "Reasoning Ability",
                    topics: [
                        "Puzzles (Seating Arrangement, Floor, Box, etc.)",
                        "Syllogism",
                        "Inequalities",
                        "Coding-Decoding",
                        "Blood Relations",
                        "Direction Sense",
                        "Data Sufficiency",
                        "Input-Output",
                        "Alphanumeric Series",
                        "Verbal Reasoning"
                    ]
                },
                {
                    name: "English Language",
                    topics: [
                        "Reading Comprehension",
                        "Cloze Test",
                        "Para Jumbles",
                        "Error Spotting",
                        "Fill in the Blanks",
                        "Sentence Correction",
                        "Vocabulary (Synonyms, Antonyms)"
                    ]
                },
                {
                    name: "Phase I - Others",
                    topics: [
                        "General knowledge, Current events not covered elsewhere",
                        "Computer knowledge basics (if applicable)"
                    ]
                }
            ]
        },
        "Phase II": {
            title: "Phase II (Mains)",
            sections: [
                {
                    name: "Economic and Social Issues (ESI)",
                    topics: [
                        "Growth and Development: Measurement of Growth – National Income and per capita income",
                        "Growth and Development: Poverty Alleviation and Employment Generation in India – status, challenges, initiatives",
                        "Growth and Development: Sustainable Development and Environmental issues – concepts, policies, international agreements",
                        "Indian Economy: Economic History of India – pre and post-independence overview",
                        "Indian Economy: Changes in Industrial Policy, Liberalization, Privatization, Globalization (LPG Reforms)",
                        "Indian Economy: Inflation – Definition, Trends, Estimates, Consequences, and Remedies",
                        "Indian Economy: Economic Reforms in India – Financial Sector Reforms, External Sector Reforms (Trade & Capital Account Convertibility)",
                        "Indian Economy: Industrial and Labour Policy – recent changes, impact",
                        "Indian Economy: Monetary and Fiscal Policy – meaning, objectives, instruments, recent stance",
                        "Indian Economy: Privatization – Disinvestment policy and its implications",
                        "Indian Economy: Role of Economic Planning in India – NITI Aayog, Five-Year Plans (historical context)",
                        "Indian Economy: Agriculture and Rural Development – Issues, challenges, government initiatives (schemes, policies)",
                        "Indian Economy: Union Budget – Concepts, Approach, and Broad Trends (recent budget analysis)",
                        "Globalization: Opening up of the Indian Economy – historical context and impact",
                        "Globalization: Balance of Payments (BOP), Export-Import Policy – concepts, current trends",
                        "Globalization: International Economic Institutions – IMF, World Bank, WTO, ADB, AIIB – roles and functions",
                        "Globalization: Regional Economic Cooperation – various blocs, agreements (e.g., SAARC, ASEAN)",
                        "Social Structure in India: Multiculturalism – challenges and strengths",
                        "Social Structure in India: Demographic Trends – population growth, age structure, demographic dividend",
                        "Social Structure in India: Urbanization and Migration – causes, challenges and policies (e.g., Smart Cities)",
                        "Social Structure in India: Gender Issues – empowerment, equality, laws, government schemes",
                        "Social Structure in India: Social Justice: Positive Discrimination in favour of the underprivileged – reservations, affirmative action",
                        "Social Structure in India: Social Movements – types, causes, impacts (e.g., environmental, farmers')",
                        "Social Structure in India: Indian Political System – basics of governance, constitutional framework",
                        "Social Structure in India: Human Development – Human Development Index (HDI), challenges in India",
                        "Social Structure in India: Social Sectors in India: Health and Education initiatives and policies (e.g., Ayushman Bharat, NEP)"
                    ]
                },
                {
                    name: "English (Writing Skills)",
                    topics: [
                        "Essay Writing",
                        "Precis Writing",
                        "Reading Comprehension (Descriptive Answers)"
                    ]
                },
                {
                    name: "Finance",
                    topics: [
                        "Chapter 1: Introduction to the Indian Financial System",
                        "Chapter 2A: Time Value of Money",
                        "Chapter 2B: Primary and Secondary Market – Bond Market",
                        "Chapter 3A: Basics of Derivatives – Futures, Forwards and Swaps",
                        "Chapter 3B: Basics of Derivatives – Options",
                        "Chapter 4: Primary and Secondary Market – Equity Market",
                        "Chapter 5: Primary and Secondary Market – Debt Market",
                        "Chapter 6: Primary and Secondary Market – Forex Market",
                        "Chapter 7: Alternate Sources of Finance",
                        "Chapter 8: Banking System in India – Structure and Developments",
                        "Chapter 9: RBI and Its Functions",
                        "Chapter 10: Financial Institution",
                        "Chapter 11: Non-Banking System",
                        "Chapter 12: Financial Inclusion",
                        "Chapter 13: Development in the Digital Payment System",
                        "Chapter 14: Role of IT in Banking and Financial System",
                        "Chapter 15: Corporate Governance in Banks",
                        "Chapter 16: Global Financial System and International Banking",
                        "Chapter 17: Financial Risk Management",
                        "Chapter 18: Introduction to Basics of Accounting",
                        "Chapter 19: Financial Statement – Income Statement (P&L Account)",
                        "Chapter 20: Financial Statement – Balance Sheet",
                        "Chapter 21: Financial Statement – Cash Flow",
                        "Chapter 22: Ratios Analysis",
                        "Chapter 23: Union Budget – Concepts, Approach and Broad Trend",
                        "Chapter 24: Inflation",
                        "Chapter 25: Public Private Partnership",
                        "Chapter 26: Recent Developments in the Global Financial System and its Impact on Indian Financial System",
                        "Chapter 27: Descriptive Q&A on Important Reports and Current Affairs",
                        "Chapter 28: Fringe Topics"
                    ]
                },
                {
                    name: "Management",
                    topics: [
                        "Chapter 1: Motivation Part 1",
                        "Chapter 2: Motivation Part 2",
                        "Chapter 2A: Science and Art of Descriptive Writing",
                        "Chapter 3: Communication",
                        "Chapter 4: Leadership Part 1",
                        "Chapter 5: Leadership Part 2",
                        "Chapter 6: General Management Part 1",
                        "Chapter 7: General Management Part 2",
                        "Chapter 8: General Management Part 3",
                        "Chapter 9: General Management Part 4",
                        "Chapter 10: Fundamentals of Organizational Behaviour",
                        "Chapter 11: Personality and Perception",
                        "Chapter 12: Emotional Intelligence and Interpersonal Behaviour",
                        "Chapter 13: Conflict",
                        "Chapter 14: Organizational Change",
                        "Chapter 15: Corporate Governance",
                        "Chapter 16: Ethics",
                        "Chapter 17: Fringe Topics"
                    ]
                }
            ]
        },
        "Phase III": {
            title: "Phase III (Interview)",
            sections: [
                {
                    name: "Interview",
                    topics: [
                        "Personality Assessment",
                        "General Knowledge and Current Affairs related to Banking and Economy",
                        "Understanding of RBI's role and functions",
                        "Leadership qualities and communication skills",
                        "Situational and Behavioral Questions"
                    ]
                },
                {
                    name: "Phase III - Others",
                    topics: [
                        "Group Discussions (if applicable)",
                        "Psychometric Test related preparation"
                    ]
                }
            ]
        }
    };

    // Pre-populate data function
    const populateInitialData = async (firestore, currentUserId) => {
        if (!firestore || !currentUserId) return;

        const dailyNewsCollectionRef = collection(firestore, `artifacts/${appId}/users/${currentUserId}/dailyFinancialNews`);
        const notesCollectionRef = collection(firestore, `artifacts/${appId}/users/${currentUserId}/notes`);
        const chapterProgressCollectionRef = collection(firestore, `artifacts/${appId}/users/${currentUserId}/chapterProgress`); // New collection

        // Check if data already exists to avoid duplicates
        const existingNewsSnapshot = await getDocs(query(dailyNewsCollectionRef));
        const existingNotesSnapshot = await getDocs(query(notesCollectionRef));
        const existingProgressSnapshot = await getDocs(query(chapterProgressCollectionRef));


        if (!existingNewsSnapshot.empty || !existingNotesSnapshot.empty || !existingProgressSnapshot.empty) {
            console.log("Existing data found, skipping initial population.");
            return;
        }

        console.log("Populating initial data...");

        // Sample Daily Financial News
        const sampleNews = [
            {
                date: "2025-06-17",
                summaryText: "RBI's Monetary Policy Committee maintains the repo rate at 6.5%, citing concerns over persistent inflation. Governor emphasizes flexible inflation targeting amidst global uncertainties.",
                phase: "Phase I",
                subject: "General Awareness",
                chapter: "Monetary Plans",
                createdAt: new Date("2025-06-17T10:00:00Z").toISOString()
            },
            {
                date: "2025-06-16",
                summaryText: "India's trade deficit widens in May as global demand for key exports slows. Imports, particularly crude oil, remain elevated. Government explores new trade agreements.",
                phase: "Phase II",
                subject: "Economic and Social Issues (ESI)",
                chapter: "Globalization: Export-Import Policy – concepts, current trends",
                createdAt: new Date("2025-06-16T11:30:00Z").toISOString()
            },
            {
                date: "2025-06-15",
                summaryText: "Public sector banks report healthy Q1 earnings, driven by improved asset quality and credit growth. Focus shifts to digitalization and customer-centric initiatives.",
                phase: "Phase II",
                subject: "Finance",
                chapter: "Chapter 8: Banking System in India – Structure and Developments",
                createdAt: new Date("2025-06-15T09:45:00Z").toISOString()
            },
            {
                date: "2025-06-14",
                summaryText: "Government launches 'Skill India Mission 2.0' with enhanced focus on green skills and AI integration, aiming to boost employment generation and future-ready workforce.",
                phase: "Phase II",
                subject: "Economic and Social Issues (ESI)",
                chapter: "Growth and Development: Poverty Alleviation and Employment Generation in India – status, challenges, initiatives",
                createdAt: new Date("2025-06-14T12:15:00Z").toISOString()
            },
            {
                date: "2025-06-13",
                summaryText: "SEBI introduces new norms for mutual funds to enhance transparency and protect investor interests, particularly regarding liquidity risk management.",
                phase: "Phase II",
                subject: "Finance",
                chapter: "Chapter 2B: Primary and Secondary Market – Bond Market", // Could also be Equity Market or other financial market chapters
                createdAt: new Date("2025-06-13T08:00:00Z").toISOString()
            }
        ];

        // Sample Notes
        const sampleNotes = [
            {
                title: "Key Concepts of Inflation",
                content: "Inflation refers to the sustained increase in the general price level of goods and services in an economy over a period of time. It reduces the purchasing power of currency. Main types: Demand-Pull (excess demand) and Cost-Push (supply shocks, increased production costs). Measures: CPI (Consumer Price Index) and WPI (Wholesale Price Index). RBI primarily uses CPI for policy decisions. Tools to control inflation: monetary policy (repo rate, CRR, OMO) and fiscal policy (government spending, taxation).",
                phase: "Phase II",
                subject: "Economic and Social Issues (ESI)",
                chapter: "Indian Economy: Inflation – Definition, Trends, Estimates, Consequences, and Remedies",
                createdAt: new Date("2025-06-10T14:00:00Z").toISOString()
            },
            {
                title: "Basics of Repo Rate",
                content: "The Repo Rate (Repurchase Option Rate) is the rate at which the Reserve Bank of India (RBI) lends money to commercial banks in India against government securities. It is a key monetary policy tool used by the RBI to control inflation and manage liquidity in the economy. An increase in the repo rate makes borrowing more expensive for banks, leading to higher lending rates for consumers and businesses, thus curbing inflation.",
                phase: "Phase I",
                subject: "General Awareness",
                chapter: "Banking Terms",
                createdAt: new Date("2025-06-09T16:30:00Z").toISOString()
            },
            {
                title: "Leadership Styles Summary",
                content: "Effective leadership is crucial in management. Key styles include: \n1. Autocratic: Leader makes decisions independently. \n2. Democratic: Leader involves team in decision-making. \n3. Laissez-faire: Leader provides minimal guidance, allowing autonomy. \n4. Transformational: Inspires and motivates followers to achieve beyond expectations. \n5. Transactional: Focuses on supervision, organization, and performance through rewards and punishments. The best style depends on the situation and team maturity.",
                phase: "Phase II",
                subject: "Management",
                chapter: "Chapter 4: Leadership Part 1", // Assuming this fits, adjust if a more specific one exists
                createdAt: new Date("2025-06-08T11:00:00Z").toISOString()
            },
            {
                title: "Financial Inclusion Strategies",
                content: "Financial Inclusion aims to provide affordable financial services to all sections of society, especially vulnerable groups. Key initiatives in India include: Jan Dhan Yojana (no-frills accounts), Mudra Yojana (micro-loans), Atal Pension Yojana, Pradhan Mantri Jeevan Jyoti Bima Yojana (life insurance), Pradhan Mantri Suraksha Bima Yojana (accident insurance). Digital payments (UPI, AEPS) are also crucial for last-mile delivery.",
                phase: "Phase II",
                subject: "Finance",
                chapter: "Chapter 12: Financial Inclusion",
                createdAt: new Date("2025-06-07T09:00:00Z").toISOString()
            },
            {
                title: "Puzzles for Reasoning Ability - Tips",
                content: "Solving puzzles in Reasoning Ability requires systematic thinking. Tips: \n1. Read all conditions carefully before starting. \n2. Draw diagrams (e.g., seating arrangements, grids) to visualize information. \n3. Note down definite information first. \n4. Use deductions to eliminate possibilities. \n5. Identify keywords like 'not', 'only', 'either/or'. \n6. For complex puzzles, consider multiple cases or tables. Practice regularly to improve speed and accuracy.",
                phase: "Phase I",
                subject: "Reasoning Ability",
                chapter: "Puzzles (Seating Arrangement, Floor, Box, etc.)",
                createdAt: new Date("2025-06-06T15:00:00Z").toISOString()
            },
            {
                title: "Economic Current Affairs - Q1 2025",
                content: "Summary of key economic events and policy changes in Q1 2025, including inflation data, GDP growth projections, and major government economic announcements.",
                phase: "Phase I",
                subject: "General Awareness",
                chapter: "Current Affairs (Date-wise)",
                createdAt: new Date("2025-03-31T18:00:00Z").toISOString()
            },
            {
                title: "May 2025 Monetary Policy Highlights",
                content: "Key decisions from the RBI's May 2025 Monetary Policy Committee meeting. Focus on liquidity management, interest rate corridor, and new regulatory measures for NBFCs.",
                phase: "Phase I",
                subject: "General Awareness",
                chapter: "Current Affairs (Date-wise)",
                createdAt: new Date("2025-05-10T11:00:00Z").toISOString()
            },
            {
                title: "Indian Financial System Overview",
                content: "Detailed overview of the Indian financial system, covering its structure, key institutions (RBI, SEBI, IRDAI, PFRDA), financial markets (money market, capital market), and financial instruments.",
                phase: "Phase I",
                subject: "General Awareness",
                chapter: "Indian Financial System",
                createdAt: new Date("2025-06-01T09:00:00Z").toISOString()
            },
            {
                title: "Reading Comprehension Strategy",
                content: "Tips and strategies for excelling in Reading Comprehension sections of competitive exams. Focus on identifying main ideas, inferring meaning, and time management.",
                phase: "Phase I",
                subject: "English Language",
                chapter: "Reading Comprehension",
                createdAt: new Date("2025-06-05T10:00:00Z").toISOString()
            },
            {
                title: "DI Caselet Practice Set 1",
                content: "Practice questions for Data Interpretation Caselets, focusing on various types of data representation and logical deduction.",
                phase: "Phase I",
                subject: "Quantitative Aptitude",
                chapter: "Data Interpretation (Tables, Graphs, Caselets)",
                createdAt: new Date("2025-06-03T14:00:00Z").toISOString()
            }
        ];

        for (const newsItem of sampleNews) {
            const docRef = doc(dailyNewsCollectionRef); // Let Firestore auto-generate ID
            await setDoc(docRef, newsItem);
        }
        console.log("Daily News populated.");

        for (const noteItem of sampleNotes) {
            const docRef = doc(notesCollectionRef); // Let Firestore auto-generate ID
            await setDoc(docRef, noteItem);
        }
        console.log("Notes populated.");
        showMessageModal("Initial sample data loaded successfully!");
    };


    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const firestoreInstance = getFirestore(app);
            const storageInstance = getStorage(app);

            setAuth(authInstance);
            setDb(firestoreInstance);
            setStorage(storageInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    console.log("User authenticated:", user.uid);
                    // Attempt to populate initial data AFTER user is authenticated
                    await populateInitialData(firestoreInstance, user.uid);
                } else {
                    console.log("No user, attempting anonymous sign-in or custom token sign-in.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                            setUserId(authInstance.currentUser?.uid);
                            await populateInitialData(firestoreInstance, authInstance.currentUser?.uid);
                        } else {
                            const anonUser = await signInAnonymously(authInstance);
                            setUserId(anonUser.user.uid);
                            await populateInitialData(firestoreInstance, anonUser.user.uid);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        showMessageModal(`Authentication failed: ${error.message}`);
                    }
                }
                setLoading(false);
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessageModal(`Firebase initialization error: ${error.message}`);
            setLoading(false);
        }
    }, []);

    useEffect(() => {
        if (db && userId) {
            const studyPlansCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/studyPlans`);
            const unsubscribeStudyPlans = onSnapshot(query(studyPlansCollectionRef), (snapshot) => {
                const plansData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setStudyPlans(plansData);
                console.log("Fetched study plans:", plansData);
                // If a plan was selected, re-select it to update its tasks if it changed
                // if (selectedPlan && plansData.some(plan => plan.id === selectedPlan.id)) {
                //     setSelectedPlan(plansData.find(plan => plan.id === selectedPlan.id));
                // }
            }, (error) => {
                console.error("Error fetching study plans:", error);
                showMessageModal(`Error fetching study plans: ${error.message}`);
            });

            const notesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/notes`);
            const unsubscribeNotes = onSnapshot(query(notesCollectionRef), (snapshot) => {
                const notesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setNotes(notesData.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                console.log("Fetched notes:", notesData);
            }, (error) => {
                console.error("Error fetching notes:", error);
                showMessageModal(`Error fetching notes: ${error.message}`);
            });

            const quizResultsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/quizResults`);
            const unsubscribeQuizResults = onSnapshot(query(quizResultsCollectionRef), (snapshot) => {
                const resultsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setQuizResults(resultsData.sort((a, b) => new Date(b.date) - new Date(a.date)));
            }, (error) => {
                console.error("Error fetching quiz results:", error);
                showMessageModal(`Error fetching quiz results: ${error.message}`);
            });

            // Listen for changes in chapter progress
            const chapterProgressCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/chapterProgress`);
            const unsubscribeChapterProgress = onSnapshot(query(chapterProgressCollectionRef), (snapshot) => {
                const progressData = {};
                snapshot.docs.forEach(doc => {
                    progressData[doc.id] = doc.data();
                });
                setChapterProgress(progressData);
                console.log("Fetched chapter progress:", progressData);
            }, (error) => {
                console.error("Error fetching chapter progress:", error);
                showMessageModal(`Error fetching chapter progress: ${error.message}`);
            });

            const dailyNewsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dailyFinancialNews`);
            const unsubscribeDailyNews = onSnapshot(query(dailyNewsCollectionRef), (snapshot) => {
                const newsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setDailyNews(newsData.sort((a, b) => new Date(b.date) - new Date(a.date)));
                console.log("Fetched daily financial news:", newsData);
            }, (error) => {
                console.error("Error fetching daily news:", error);
                showMessageModal(`Error fetching daily news: ${e.message}`);
            });


            return () => {
                unsubscribeStudyPlans();
                unsubscribeNotes();
                unsubscribeQuizResults();
                unsubscribeChapterProgress(); // Unsubscribe from new listener
                unsubscribeDailyNews();
            };
        }
    }, [db, userId]); // Removed selectedPlan from dependency array


    const handleCreateStudyPlan = async () => {
        if (!newPlanName.trim()) {
            showMessageModal("Study plan name cannot be empty.");
            return;
        }
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }

        try {
            const existingPlan = studyPlans.find(plan => plan.name === newPlanName.trim());
            if (existingPlan) {
                showMessageModal("A study plan with this name already exists. Please choose a different name.");
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/studyPlans/${newPlanName}`);
            await setDoc(docRef, { name: newPlanName, createdAt: new Date().toISOString(), tasks: [] });
            setNewPlanName('');
            showMessageModal("Study plan created successfully!");
        } catch (e) {
                console.error("Error adding document: ", e);
            showMessageModal(`Error creating study plan: ${e.message}`);
        }
    };

    const handleAddTask = async () => {
        if (!newTaskContent.trim()) {
            showMessageModal("Task content cannot be empty.");
            return;
        }
        if (!db || !userId || !selectedPlan) {
            showMessageModal("Database, user, or plan not ready.");
            return;
        }

        const newTaskId = Date.now().toString();
        const newTask = { id: newTaskId, content: newTaskContent.trim(), completed: false, createdAt: new Date().toISOString() };

        try {
            const planRef = doc(db, `artifacts/${appId}/users/${userId}/studyPlans/${selectedPlan.id}`);
            await updateDoc(planRef, {
                tasks: arrayUnion(newTask)
            });
            setNewTaskContent('');
            showMessageModal("Task added successfully!");
        } catch (e) {
            console.error("Error adding task: ", e);
            showMessageModal(`Error adding task: ${e.message}`);
        }
    };

    const handleToggleTaskComplete = async (planId, taskToToggle) => {
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }

        const planToUpdate = studyPlans.find(p => p.id === planId);
        if (!planToUpdate) {
            console.error("Plan not found for toggling task.");
            return;
        }

        const updatedTasks = planToUpdate.tasks.map(task =>
            task.id === taskToToggle.id ? { ...task, completed: !task.completed } : task
        );

        try {
            const planRef = doc(db, `artifacts/${appId}/users/${userId}/studyPlans/${planId}`);
            await updateDoc(planRef, {
                tasks: updatedTasks
            });
            showMessageModal(`Task marked as ${taskToToggle.completed ? 'incomplete' : 'complete'}!`);
        } catch (e) {
            console.error("Error updating task: ", e);
            showMessageModal(`Error updating task: ${e.message}`);
        }
    };

    const handleDeleteTask = async (planId, taskToDelete) => {
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }
        const planToUpdate = studyPlans.find(p => p.id === planId);
        if (!planToUpdate) {
            console.error("Plan not found for deleting task.");
            return;
        }

        try {
            const planRef = doc(db, `artifacts/${appId}/users/${userId}/studyPlans/${planId}`);
            await updateDoc(planRef, {
                tasks: arrayRemove(taskToDelete)
            });
            showMessageModal("Task deleted successfully!");
        } catch (e) {
            console.error("Error deleting task: ", e);
            showMessageModal(`Error deleting task: ${e.message}`);
        }
    };

    const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
            setSelectedFile(file);
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            const textFileTypes = ['txt', 'md'];
            const supportedBinaryFileTypes = ['pdf', 'doc', 'docx', 'xls', 'xlsx'];

            // Clear existing content if a new file is selected, especially if it's a binary file
            if (!textFileTypes.includes(fileExtension)) {
                 setNewNoteContent(''); // Clear text area if a binary file is selected
            }

            if (textFileTypes.includes(fileExtension)) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        setNewNoteContent(e.target.result); // Load text content into the textarea for preview/editing
                        showMessageModal(`'${fileName}' selected and content loaded for preview.`);
                    } catch (error) {
                        console.error("Error reading text file:", error);
                        showMessageModal(`Error reading file: ${error.message}`);
                    }
                };
                reader.onerror = (e) => {
                    console.error("File reading error:", reader.error);
                    showMessageModal("Failed to read file.");
                };
                reader.readAsText(file);
            } else if (supportedBinaryFileTypes.includes(fileExtension)) {
                showMessageModal(`'${fileName}' selected. Binary files like PDF/Word/Excel will be uploaded to Firebase Storage.`);
            } else {
                setNewNoteContent('');
                setSelectedFile(null);
                showMessageModal("Unsupported file type. Please upload .txt, .md, .pdf, .doc, .docx, or .xls, or .xlsx files for notes.");
            }
        } else {
            setSelectedFile(null);
        }
    };

    const handleSaveNote = async () => {
        if (!noteTitle.trim()) {
            showMessageModal("Note title cannot be empty.");
            return;
        }

        let chapterToSave = selectedNoteChapter;
        if (selectedNoteSubject === "General Awareness" && selectedNoteChapter === "Current Affairs (Date-wise)") {
            if (!currentAffairsDateInput) {
                showMessageModal("Please select a date for Daily Current Affairs.");
                return;
            }
            chapterToSave = currentAffairsDateInput;
        }

        // Validate content: Must have either selectedFile OR newNoteContent
        if (!selectedFile && !newNoteContent.trim()) {
            showMessageModal("Please upload a file or enter text content for the note.");
            return;
        }
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }

        const MAX_FIRESTORE_FILE_SIZE_BYTES = 1 * 1024 * 1024; // 1MB

        try {
            const newNoteRef = doc(collection(db, `artifacts/${appId}/users/${userId}/notes`));
            let fileDownloadUrl = null;
            let uploadedFileName = selectedFile ? selectedFile.name : '';
            let noteContentForFirestore = newNoteContent; // Default to textarea content
            let isContentBase64Encoded = false;

            if (selectedFile) {
                const fileName = selectedFile.name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                const textFileTypes = ['txt', 'md'];
                const supportedBinaryFileTypes = ['pdf', 'doc', 'docx', 'xls', 'xlsx'];

                // For text files, always read content into noteContentForFirestore for direct display
                // This overrides whatever was in the textarea if a text file is uploaded
                if (textFileTypes.includes(fileExtension)) {
                    noteContentForFirestore = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(reader.error);
                        reader.readAsText(selectedFile);
                    });
                }

                // Attempt to upload the original file to Firebase Storage regardless of its type.
                // This also applies if it's a text file whose content is primarily saved in Firestore directly.
                try {
                    if (storage) {
                        const storageRef = ref(storage, `artifacts/${appId}/users/${userId}/files/${newNoteRef.id}/${selectedFile.name}`);
                        await uploadBytes(storageRef, selectedFile);
                        fileDownloadUrl = await getDownloadURL(storageRef);
                        showMessageModal("File uploaded to Firebase Storage.");
                    } else {
                        throw new Error("Firebase Storage not initialized.");
                    }
                } catch (storageError) {
                    console.warn("Firebase Storage upload failed:", storageError.message);
                    showMessageModal(`Storage upload failed for file: ${storageError.message}.`);

                    // Fallback for supported binary files (not text files) if Storage fails and small enough
                    if (supportedBinaryFileTypes.includes(fileExtension) && !textFileTypes.includes(fileExtension)) {
                        if (selectedFile.size > MAX_FIRESTORE_FILE_SIZE_BYTES) {
                            showMessageModal(`File too large (${(selectedFile.size / (1024 * 1024)).toFixed(2)} MB) for direct database storage. Not saving as attachment.`);
                            fileDownloadUrl = null; // Changed to match local variable name
                            uploadedFileName = '';
                        } else {
                            noteContentForFirestore = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result);
                                reader.onerror = (e) => reject(reader.error);
                                reader.readAsDataURL(selectedFile);
                            });
                            isContentBase64Encoded = true;
                            fileDownloadUrl = null; // No storage URL if saved as base64
                            showMessageModal("File converted to Base64 and saved directly to database. Note: Large Base64 files may impact performance.");
                        }
                    } else if (!textFileTypes.includes(fileExtension)) {
                        // If it's an unsupported file type AND storage failed, clear file info
                        showMessageModal("Uploaded file type is unsupported and storage upload failed. No file will be attached.");
                        fileDownloadUrl = null; // Changed to match local variable name
                        uploadedFileName = '';
                        // Also clear content if it was only from this unsupported file and not from textarea
                        if (noteContentForFirestore === selectedFile.name) { // Simple check, assuming only file name was shown initially
                             noteContentForFirestore = '';
                        }
                    }
                    // If it was a text file and storage failed, its content is already in noteContentForFirestore from above, so nothing else needed here for content.
                }
            }

            await setDoc(newNoteRef, {
                title: noteTitle.trim(),
                content: noteContentForFirestore, // This is the final content to save
                phase: selectedNotePhase || '',
                subject: selectedNoteSubject || '',
                chapter: chapterToSave || '',
                uploadedFile: uploadedFileName, // Filename from selectedFile
                uploadedFileUrl: fileDownloadUrl, // URL from storage
                isBase64Encoded: isContentBase64Encoded, // Flag for base64
                createdAt: new Date().toISOString()
            });

            // Reset form fields
            setNewNoteContent('');
            setSelectedNotePhase('');
            setSelectedNoteSubject('');
            setSelectedNoteChapter('');
            setCurrentAffairsDateInput('');
            setSelectedFile(null);
            setNoteTitle('');
            setShowAddNoteModal(false); // Close the modal after saving
            showMessageModal("Note saved successfully!");
        } catch (e) {
            console.error("Critical error saving note:", e);
            showMessageModal(`Failed to save note: ${e.message}`);
        }
    };


    const handleToggleChapterProgress = async (phaseKey, subjectName, chapterName, type) => {
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }

        const chapterIdentifier = `${phaseKey}___${subjectName}___${chapterName}`;
        const currentProgress = chapterProgress[chapterIdentifier] || { readNotes: false, takenTest: false };

        const updatedProgress = { ...currentProgress };

        if (type === 'readNotes') {
            updatedProgress.readNotes = !currentProgress.readNotes;
        } else if (type === 'takenTest') {
            updatedProgress.takenTest = !currentProgress.takenTest;
        }

        const chapterDocRef = doc(db, `artifacts/${appId}/users/${userId}/chapterProgress/${chapterIdentifier}`);

        try {
            await setDoc(chapterDocRef, updatedProgress, { merge: true }); // Use merge to only update specified fields
            showMessageModal(`Chapter '${chapterName}' ${type === 'readNotes' ? 'notes status' : 'test status'} updated.`);
        } catch (e) {
            console.error(`Error toggling chapter progress for ${type}:`, e);
            showMessageModal(`Error updating chapter progress: ${e.message}`);
        }
    };


    const generateQuizQuestion = async (phase = currentQuizPhase, subject = currentQuizSubject, chapter = currentQuizChapter) => {
        if (!subject || !chapter) {
            showMessageModal("Please select a subject and chapter for the quiz.");
            return;
        }

        setLlmLoading(true);
        setQuizFeedback('');
        setSelectedQuizOption('');
        setQuizQuestion('');
        setQuizOptions([]);
        setQuizAnswer('');

        const prompt = `Generate a multiple-choice quiz question specifically about "${chapter}" from the "${subject}" subject in "${phase}" of the RBI Grade B exam syllabus. Provide 4 options (A, B, C, D), and clearly indicate the single correct answer. Format the output as a JSON object with 'question', 'options' (an array of strings), and 'answer' (the correct option string).`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = {
            contents: chatHistory,
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "question": { "type": "STRING" },
                        "options": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        },
                        "answer": { "type": "STRING" }
                    },
                    "propertyOrdering": ["question", "options", "answer"]
                }
            }
        };

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);

                setQuizQuestion(parsedJson.question);
                setQuizOptions(parsedJson.options);
                setQuizAnswer(parsedJson.answer);
            } else {
                console.error("Unexpected LLM response structure:", result);
                showMessageModal("Could not generate quiz question. Please try again.");
            }
        } catch (error) {
            console.error("Error calling LLM for quiz:", error);
            showMessageModal(`Error generating quiz: ${error.message}`);
        } finally {
            setLlmLoading(false);
        }
    };

    const submitQuizAnswer = async () => {
        if (!selectedQuizOption) {
            setQuizFeedback('Please select an option before submitting.');
            return;
        }

        const isCorrect = selectedQuizOption === quizAnswer;
        setQuizFeedback(isCorrect ? 'Correct!' : `Incorrect. The correct answer was: ${quizAnswer}`);

        if (!db || !userId) {
            showMessageModal("Database or user not ready to save quiz result.");
            return;
        }

        try {
            const newQuizResultRef = doc(collection(db, `artifacts/${appId}/users/${userId}/quizResults`));
            await setDoc(newQuizResultRef, {
                question: quizQuestion,
                selectedOption: selectedQuizOption,
                correctAnswer: quizAnswer,
                isCorrect: isCorrect,
                subject: selectedQuizSubject,
                chapter: currentQuizChapter, // Save the chapter as well
                date: new Date().toISOString()
            });
            showMessageModal("Quiz result saved!");
        } catch (e) {
            console.error("Error saving quiz result: ", e);
            showMessageModal(`Error saving quiz result: ${e.message}`);
        }
    };


    const askLlmExpert = async () => {
        if (!llmQuestion.trim()) {
            showMessageModal("Please enter your question.");
            return;
        }
        setLlmLoading(true);
        setLlmAnswer('');

        const prompt = llmQuestion; // Use the direct question from the user
        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                setLlmAnswer(result.candidates[0].content.parts[0].text);
            } else {
                console.error("Unexpected LLM response structure:", result);
                showMessageModal("Could not get an answer. Please try again.");
            }
        } catch (error) {
            console.error("Error calling LLM for expert:", error);
            showMessageModal(`Error asking expert: ${error.message}`);
        } finally {
            setLlmLoading(false);
        }
    };

    const getEssayFeedback = async () => {
        if (!essayInput.trim()) {
            showMessageModal("Please enter some text to get feedback.");
            return;
        }
        setEssayLoading(true);
        setEssayFeedback('');

        const prompt = `Please provide constructive feedback on the following essay/precis for an RBI Grade B English Writing Skills exam. Focus on grammar, coherence, vocabulary, conciseness, and relevance to a typical exam topic. Provide suggestions for improvement.
        Text: ${essayInput}`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                setEssayFeedback(result.candidates[0].content.parts[0].text);
            } else {
                console.error("Unexpected LLM response structure:", result);
                showMessageModal("Could not get essay feedback. Please try again.");
            }
        } catch (error) {
            console.error("Error calling LLM for essay feedback:", error);
            showMessageModal(`Error getting essay feedback: ${error.message}`);
        } finally {
            setEssayLoading(false);
        }
    };

    const enhanceStudyPlan = async (plan) => {
        if (!plan) {
            showMessageModal("No study plan selected for enhancement.");
            return;
        }
        setPlanEnhancementLoading(true);
        setPlanEnhancementFeedback('');

        const prompt = `Given the following RBI Grade B study plan named "${plan.name}", suggest ways to enhance it. Consider breaking down topics further, suggesting time allocations, or recommending specific study approaches for a high-achiever aiming for AIR 1. Focus on actionable steps.
        Current Plan Details: Name: "${plan.name}", Created At: "${new Date(plan.createdAt).toLocaleString()}", Tasks: ${plan.tasks && plan.tasks.length > 0 ? JSON.stringify(plan.tasks.map(t => t.content + (t.completed ? ' (completed)' : ''))) : 'No specific tasks added yet.'}.`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                setPlanEnhancementFeedback(result.candidates[0].content.parts[0].text);
            } else {
                console.error("Unexpected LLM response structure:", result);
                showMessageModal("Could not enhance study plan. Please try again.");
            }
        } catch (error) {
            console.error("Error calling LLM for plan enhancement:", error);
            showMessageModal(`Error enhancing study plan: ${error.message}`);
        } finally {
            setPlanEnhancementLoading(false);
        }
    };

    // Handle saving new Daily Financial News - Now exclusively text-based
    const handleSaveDailyNews = async () => {
        if (!newNewsDate) {
            showMessageModal("Please select a date for the news entry.");
            return;
        }
        if (!newNewsSummary.trim()) {
            showMessageModal("Please enter a summary for the news entry.");
            return;
        }
        if (!db || !userId) {
            showMessageModal("Database or user not ready.");
            return;
        }

        try {
            const newNewsRef = doc(collection(db, `artifacts/${appId}/users/${userId}/dailyFinancialNews`));
            
            await setDoc(newNewsRef, {
                date: newNewsDate,
                summaryText: newNewsSummary.trim(), // Store summary text directly
                phase: newsPhase || '',
                subject: newsSubject || '',
                chapter: newsChapter || '',
                createdAt: new Date().toISOString()
            });

            showMessageModal("Daily news summary saved successfully!");

            // Reset form fields and close modal
            setNewNewsDate('');
            setNewNewsSummary('');
            setNewsPhase('');
            setNewNewsSubject('');
            setNewNewsChapter('');
            setShowAddNewsModal(false);
        } catch (e) {
            console.error("Error saving daily news: ", e);
            showMessageModal(`Error saving news: ${e.message}`);
        }
    };

    // Function to generate test questions based on notes
    const handleGenerateChapterTest = async (chapterName) => {
        setIsTestLoading(true);
        setGeneratedTestQuestions([]);
        setTestAnswers({}); // Clear previous answers
        setTestResults(null); // Clear previous results
        setCurrentTestChapter(chapterName);
        setCurrentTestSubject(currentNoteSubject);
        setCurrentTestPhase(currentNotePhase);

        const relevantNotes = notes.filter(note =>
            note.phase === currentNotePhase &&
            note.subject === currentNoteSubject &&
            note.chapter === chapterName &&
            note.content // Ensure note has content
        );

        if (relevantNotes.length === 0) {
            showMessageModal("No notes found for this chapter to generate a test from. Please add some notes first.");
            setIsTestLoading(false);
            return;
        }

        let combinedNotesContent = relevantNotes.map(note => `Title: ${note.title}\nContent: ${note.content}`).join("\n\n---\n\n");

        // Increase max content length for 25 questions, keeping in mind LLM context window limits
        const maxContentLength = 20000; // Adjusted for more questions, but still a safeguard
        if (combinedNotesContent.length > maxContentLength) {
            combinedNotesContent = combinedNotesContent.substring(0, maxContentLength) + "\n... (content truncated)";
            showMessageModal("Notes content truncated for test generation due to length. Consider adding more concise notes.");
        }

        // Prompt to generate 25 MCQs with explanations
        const prompt = `Based on the following information about the RBI Grade B exam syllabus chapter "${chapterName}" in "${currentNoteSubject}" from "${currentNotePhase}", generate a test consisting of 25 multiple-choice questions. Each question should have 4 options (A, B, C, D) and a single correct answer. Provide a concise explanation for why the answer is correct. Focus on important concepts, facts, or applications relevant to an RBI Grade B exam. Ensure diversity in question types. The output should be a JSON array of objects, where each object has 'question', 'options' (an array of strings), 'answer' (the correct option string, e.g., "A. Option Text"), and 'explanation' (a string explaining the answer).
        \n\nProvided Notes/Context:\n${combinedNotesContent}\n\n`;

        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = {
            contents: chatHistory,
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "question": { "type": "STRING" },
                            "options": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" }
                            },
                            "answer": { "type": "STRING" },
                            "explanation": { "type": "STRING" } // Added explanation field
                        },
                        "propertyOrdering": ["question", "options", "answer", "explanation"]
                    }
                }
            }
        };

        const apiKey = ""; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedQuestions = JSON.parse(jsonText);
                setGeneratedTestQuestions(parsedQuestions);
                setCurrentPage('take-test'); // Navigate to the test page
            } else {
                console.error("Unexpected LLM response structure for test generation:", result);
                showMessageModal("Could not generate test questions. Please try again or ensure sufficient notes for the chapter.");
            }
        } catch (error) {
            console.error("Error calling LLM for test generation:", error);
            showMessageModal(`Error generating test: ${error.message}`);
        } finally {
            setIsTestLoading(false);
        }
    };

    const handleTestOptionChange = (questionIndex, selectedOption) => {
        setTestAnswers(prev => ({
            ...prev,
            [questionIndex]: selectedOption
        }));
    };

    const submitTest = () => {
        let score = 0;
        const results = generatedTestQuestions.map((q, index) => {
            const userAnswer = testAnswers[index];
            const isCorrect = userAnswer === q.answer;
            if (isCorrect) {
                score++;
            }
            return {
                question: q.question,
                selectedOption: userAnswer || "Not Answered",
                correctAnswer: q.answer,
                isCorrect: isCorrect,
                explanation: q.explanation, // Include explanation
                subject: currentTestSubject,
                chapter: currentTestChapter,
                date: new Date().toISOString()
            };
        });

        setTestResults({
            score: score,
            total: generatedTestQuestions.length,
            details: results
        });
        showMessageModal(`Test submitted! You scored ${score} out of ${generatedTestQuestions.length}.`);

        // Save individual quiz results to Firestore (optional, but good for tracking)
        results.forEach(async (result) => {
            if (db && userId) {
                try {
                    const newQuizResultRef = doc(collection(db, `artifacts/${appId}/users/${userId}/quizResults`));
                    await setDoc(newQuizResultRef, result);
                } catch (e) {
                    console.error("Error saving individual test question result: ", e);
                }
            }
        });
    };


    const getSyllabusTopics = (phaseKey, sectionName) => {
        const phase = rbiSyllabus[phaseKey];
        if (phase) {
            const section = phase.sections.find(s => s.name === sectionName);
            return section ? section.topics : [];
        }
        return [];
    };

    const allSubjectNames = [];
    for (const phaseKey in rbiSyllabus) {
        rbiSyllabus[phaseKey].sections.forEach(section => {
            if (!allSubjectNames.includes(section.name)) {
                allSubjectNames.push(section.name);
            }
        });
    }

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-center text-lg font-semibold text-gray-700">Loading application...</div>
            </div>
        );
    }

    const NoteModal = ({ note, onClose }) => {
        if (!note) return null;

        let displayedContent = '';
        let fileActionElement = null; // Renamed to be more general

        // Function to handle opening base64 files
        const handleViewBase64File = () => {
            if (note.isBase64Encoded && note.content && note.content.startsWith('data:')) {
                const parts = note.content.split(',');
                const mimeType = parts[0].split(':')[1].split(';')[0];
                const base64Data = parts[1];

                // Decode base64 and create a Blob
                // Note: atob() only works for ASCII. For general binary data, a more robust solution
                // involves converting base64 to ArrayBuffer:
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType });

                const objectURL = URL.createObjectURL(blob);
                window.open(objectURL, '_blank');

                // Clean up the object URL after a short delay, as the new window has opened it.
                // It's not strictly necessary for simple cases where the browser manages the new tab,
                // but good practice.
                // setTimeout(() => URL.revokeObjectURL(objectURL), 1000);
            }
        };

        if (note.uploadedFileUrl) {
            // For files uploaded to Firebase Storage
            displayedContent = 'File attached via Firebase Storage. Click "View/Download" to open.';
            fileActionElement = (
                <a
                    href={note.uploadedFileUrl}
                    target="_blank" // Always open in a new tab
                    rel="noopener noreferrer"
                    className="ml-2 text-blue-600 hover:underline flex items-center"
                    title="View/Download File"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    View/Download
                </a>
            );
        } else if (note.isBase64Encoded && note.content && note.content.startsWith('data:')) {
            // For Base64 encoded content stored directly in Firestore
            const mimeType = note.content.split(';')[0].split(':')[1];
            const fileNameWithExtension = note.uploadedFile || `downloaded_file.${mimeType.split('/')[1] || 'bin'}`;

            if (mimeType.includes('pdf') || mimeType.startsWith('image/')) {
                // If it's a PDF or an image, use handleViewBase64File to open in new tab
                displayedContent = `File content stored directly in database (Base64 encoded ${mimeType}). Click "View" to open in a new window.`;
                fileActionElement = (
                    <button
                        onClick={handleViewBase64File} // Use button to trigger window.open with Blob URL
                        className="ml-2 text-blue-600 hover:underline flex items-center"
                        title="View File"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        View
                    </button>
                );
            } else {
                // For other Base64 types (e.g., doc, xls), force download as browsers can't render these directly from data: URLs
                displayedContent = `File content stored directly in database (Base64 encoded ${mimeType}). Click "Download" to open.`;
                fileActionElement = (
                    <a
                        href={note.content}
                        download={fileNameWithExtension} // Force download
                        className="ml-2 text-blue-600 hover:underline flex items-center"
                        title="Download File"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Download
                    </a>
                );
            }
        } else if (note.content && note.content.trim() !== '') {
            displayedContent = note.content;
        } else {
            displayedContent = 'No content available for this note.';
        }

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                        <X size={24} />
                    </button>
                    <h3 className="text-2xl font-bold text-gray-800 mb-4">{note.title || 'Note Details'}</h3>
                    <p className="text-sm text-gray-600 mb-2">
                        **Phase:** {note.phase ? (rbiSyllabus[note.phase]?.title || note.phase) : 'Not specified'} &bull;
                        **Subject:** {note.subject || 'Not specified'} &bull;
                        **Chapter:** {note.chapter || 'Not specified'}
                    </p>
                    <hr className="my-4 border-gray-200" />
                    {/* The content div no longer has fixed max-height or overflow properties, allowing its content to push the modal's scrollbar if needed. */}
                    <div className="text-gray-800 whitespace-pre-wrap mb-4 p-2 bg-gray-50 rounded-lg border border-gray-100">
                        {displayedContent}
                    </div>
                    {note.uploadedFile && (note.uploadedFileUrl || note.isBase64Encoded) && (
                        <p className="text-sm text-gray-600 mb-4 flex items-center">
                            **Attached File:** <span className="font-semibold ml-1">{note.uploadedFile}</span>
                            {fileActionElement}
                        </p>
                    )}
                    <p className="text-xs text-gray-500 mt-2">Saved on: {new Date(note.createdAt).toLocaleString()}</p>
                </div>
            </div>
        );
    };

    const NewsDetailModal = ({ newsItem, onClose }) => {
        if (!newsItem) return null;

        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                        <X size={24} />
                    </button>
                    <h3 className="text-2xl font-bold text-gray-800 mb-4">News for {new Date(newsItem.date).toLocaleDateString()}</h3>
                    <p className="text-sm text-gray-600 mb-2">
                        **Date:** {new Date(newsItem.date).toLocaleDateString()}
                    </p>
                    <p className="text-sm text-gray-600 mb-2">
                        **Phase:** {newsItem.phase ? (rbiSyllabus[newsItem.phase]?.title || newsItem.phase) : 'Not specified'} &bull;
                        **Subject:** {newsItem.subject || 'Not specified'} &bull;
                        **Chapter:** {newsItem.chapter || 'Not specified'}
                    </p>
                    <hr className="my-4 border-gray-200" />

                    <div className="text-gray-800 whitespace-pre-wrap max-h-60 overflow-y-auto mb-4 p-2 bg-gray-50 rounded-lg border border-gray-100">
                        {newsItem.summaryText || 'No summary available for this news item.'}
                    </div>
                    <p className="text-xs text-gray-500 mt-2">Added on: {new Date(newsItem.createdAt).toLocaleString()}</p>
                </div>
            </div>
        );
    };


    const filteredNotes = notes.filter(note => {
        const matchesSearchTerm = searchTerm.toLowerCase() === '' ||
                                  note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  (note.uploadedFile && note.uploadedFile.toLowerCase().includes(searchTerm.toLowerCase())) ||
                                  (note.content && note.content.toLowerCase().includes(searchTerm.toLowerCase()));

        const matchesPhase = filterPhase === '' || note.phase === filterPhase;
        const matchesSubject = filterSubject === '' || note.subject === filterSubject;

        let matchesChapter = true;
        if (filterChapter !== '') {
            if (note.subject === "General Awareness" && note.chapter && note.chapter.match(/^\d{4}-\d{2}-\d{2}$/)) {
                matchesChapter = note.chapter === filterChapter;
            } else {
                matchesChapter = note.chapter === filterChapter;
            }
        }

        return matchesSearchTerm && matchesPhase && matchesSubject && matchesChapter;
    });

    // Add Note Modal Component - Defined inside App to access state variables
    const AddNoteModal = ({ onClose }) => {
        return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                        <X size={24} />
                    </button>
                    <h3 className="text-2xl font-bold text-gray-800 mb-4">Add Note for:</h3>
                    <p className="text-md text-gray-700 mb-4">
                        <span className="font-semibold">Phase:</span> {selectedNotePhase ? (rbiSyllabus[selectedNotePhase]?.title || selectedNotePhase) : 'Not Specified'} <br/>
                        <span className="font-semibold">Subject:</span> {selectedNoteSubject || 'Not Specified'} <br/>
                        <span className="font-semibold">Chapter:</span> {selectedNoteChapter || 'Not Specified'}
                    </p>
                    {showStorageRulesMessage && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4" role="alert">
                            <strong className="font-bold">Permission Error!</strong>
                            <span className="block sm:inline ml-2">To upload files, you need to update your Firebase Storage security rules. Please check the instructions provided in the chat.</span>
                        </div>
                    )}
                    <div className="space-y-4">
                        <div>
                            <label htmlFor="modalNoteTitle" className="block text-gray-700 text-lg font-medium mb-2">Note Title/Topic <span className="text-red-500">*</span>:</label>
                            <input
                                type="text"
                                id="modalNoteTitle"
                                placeholder="e.g., 'Summary of Inflation Chapter', 'Feb 15 CA highlights'"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                value={noteTitle}
                                onChange={(e) => setNoteTitle(e.target.value)}
                            />
                        </div>

                        {selectedNoteSubject === "General Awareness" && selectedNoteChapter === "Current Affairs (Date-wise)" && (
                            <div>
                                <label htmlFor="modalCurrentAffairsDateInput" className="block text-gray-700 text-lg font-medium mb-2">Date for Current Affairs (Required):</label>
                                <input
                                    type="date"
                                    id="modalCurrentAffairsDateInput"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                    value={currentAffairsDateInput}
                                    onChange={(e) => setCurrentAffairsDateInput(e.target.value)}
                                />
                            </div>
                        )}

                        <div>
                            <label htmlFor="modalNewNoteContent" className="block text-gray-700 text-lg font-medium mb-2">Note Content (or upload a file below):</label>
                            <textarea
                                id="modalNewNoteContent"
                                rows="5"
                                placeholder="Type your notes here..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                value={newNoteContent}
                                onChange={(e) => setNewNoteContent(e.target.value)}
                            ></textarea>
                        </div>

                        <div>
                            <label htmlFor="modalFileUpload" className="block text-gray-700 text-lg font-medium mb-2">Upload File (Optional: PDF, Word, Excel, Text for notes):</label>
                            <input
                                type="file"
                                id="modalFileUpload"
                                accept=".txt,.md,.pdf,.doc,.docx,.xls,.xlsx"
                                onChange={handleFileUpload}
                                className={`block w-full text-sm text-gray-500
                                           file:mr-4 file:py-2 file:px-4
                                           file:rounded-full file:border-0
                                           file:text-sm file:font-semibold
                                           file:bg-violet-50 file:text-violet-700
                                           hover:file:bg-violet-100`}
                            />
                            {selectedFile && (
                                <p className="text-sm text-gray-600 mt-2">
                                    Selected file: <span className="font-semibold">{selectedFile.name}</span>.
                                    {selectedFile.name.toLowerCase().endsWith('.txt') || selectedFile.name.toLowerCase().endsWith('.md')
                                        ? ' (Content will be saved as note text, overwriting manual input if present.)'
                                        : ' (File will be uploaded as attachment to Firebase Storage.)'
                                    }
                                </p>
                            )}
                        </div>

                        <div className="flex justify-end gap-3 mt-6">
                            <button
                                onClick={onClose}
                                className="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={handleSaveNote}
                                disabled={!noteTitle.trim() || (!selectedFile && !newNoteContent.trim()) ||
                                          (selectedNoteSubject === "General Awareness" && selectedNoteChapter === "Current Affairs (Date-wise)" && !currentAffairsDateInput)}
                                className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Save Note
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };


    const renderPage = () => {
        // Recalculate progress for dashboard
        let totalPossibleProgressUnits = 0;
        let achievedProgressUnits = 0;

        for (const phaseKey in rbiSyllabus) {
            rbiSyllabus[phaseKey].sections.forEach(section => {
                section.topics.forEach(chapterName => {
                    const chapterIdentifier = `${phaseKey}___${section.name}___${chapterName}`;
                    totalPossibleProgressUnits += 2; // 1 for notes, 1 for test

                    const chapterStatus = chapterProgress[chapterIdentifier] || { readNotes: false, takenTest: false };
                    if (chapterStatus.readNotes) {
                        achievedProgressUnits += 1;
                    }
                    if (chapterStatus.takenTest) {
                        achievedProgressUnits += 1;
                    }
                });
            });
        }
        const overallProgressPercentage = totalPossibleProgressUnits > 0 ? (achievedProgressUnits / totalPossibleProgressUnits) * 100 : 0;


        switch (currentPage) {
            case 'dashboard':
                // const totalTasksAcrossPlans = studyPlans.reduce((sum, plan) => sum + (plan.tasks ? plan.tasks.length : 0), 0);
                // const completedTasksAcrossPlans = studyPlans.reduce((sum, plan) => sum + (plan.tasks ? plan.tasks.filter(task => task.completed).length : 0), 0);
                // const overallProgressPercentage = totalTasksAcrossPlans > 0 ? (completedTasksAcrossPlans / totalTasksAcrossPlans) * 100 : 0;

                return (
                    <div className="p-6">
                        <h1 className="text-4xl font-extrabold mb-8 text-gray-900 text-center flex items-center justify-center">
                            <span role="img" aria-label="rocket" className="mr-3 text-4xl">🚀</span>
                            RBI Grade B – AIR 1 App
                        </h1>
                        <p className="text-lg text-gray-700 text-center mb-10">
                            Your complete preparation hub with notes, current affairs, MCQs, and AI coach
                        </p>

                        <div className="bg-gradient-to-br from-blue-50 to-blue-200 p-8 rounded-xl shadow-lg border border-blue-300 mb-10 text-center">
                            <h3 className="text-2xl font-bold text-blue-800 mb-4">Your Progress At A Glance</h3>
                            <div className="w-full bg-blue-300 rounded-full h-4">
                                <div
                                    className="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out"
                                    style={{ width: `${overallProgressPercentage}%` }}
                                ></div>
                            </div>
                            <p className="text-md text-blue-800 mt-3 font-semibold">Overall Syllabus Progress: {overallProgressPercentage.toFixed(0)}% Complete</p>
                        </div>


                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                            <DashboardCard
                                icon="📚"
                                title="Syllabus Overview"
                                description="Explore the detailed RBI Grade B exam syllabus phase-wise and subject-wise."
                                onClick={() => setCurrentPage('syllabus')}
                                bgColor="bg-purple-50"
                                borderColor="border-purple-200"
                                shadowColor="shadow-purple-200"
                            />

                            <DashboardCard
                                icon="📰"
                                title="Daily Financial News"
                                description="Summarized from Business Standard, PIB, Mint — organized by date with RBI chapter mapping."
                                onClick={() => setCurrentPage('daily-financial-news')}
                                bgColor="bg-blue-50"
                                borderColor="border-blue-200"
                                shadowColor="shadow-blue-200"
                            />

                            <DashboardCard
                                icon="📝"
                                title="Smart Notes Vault"
                                description="Finance, ESI, and Management notes tagged to chapters with diagrams, PDFs, and audio."
                                onClick={() => setCurrentPage('notes')}
                                bgColor="bg-green-50"
                                borderColor="border-green-200"
                                shadowColor="shadow-green-200"
                            />

                            <DashboardCard
                                icon="❓"
                                title="MCQ & PYQ Practice"
                                description="Topic-wise, chapter-wise, and past year question banks with timer and review features."
                                onClick={() => setCurrentPage('quiz')}
                                bgColor="bg-yellow-50"
                                borderColor="border-yellow-200"
                                shadowColor="shadow-yellow-200"
                            />

                            <DashboardCard
                                icon="🎯"
                                title="AIR 1 Strategy Planner"
                                description="Custom daily planner, progress tracker, and topper-style weekly milestones."
                                onClick={() => setCurrentPage('study-plan')}
                                bgColor="bg-purple-50"
                                borderColor="border-purple-200"
                                shadowColor="shadow-purple-200"
                            />

                            <DashboardCard
                                icon="🤖"
                                title="Ask AI Coach"
                                description="Clear your Finance/ESI doubts instantly, generate summaries, or get topic advice."
                                onClick={() => setCurrentPage('ai-expert')}
                                bgColor="bg-pink-50"
                                borderColor="border-pink-200"
                                shadowColor="shadow-pink-200"
                            />

                            <DashboardCard
                                icon="📈"
                                title="Performance Analysis"
                                description="Review your quiz history, track progress, and identify weak areas."
                                onClick={() => setCurrentPage('performance')}
                                bgColor="bg-gray-50"
                                borderColor="border-gray-200"
                                shadowColor="shadow-gray-200"
                            />
                        </div>

                        <div className="mt-8 p-4 bg-gray-100 rounded-lg shadow-inner text-gray-600 text-sm text-center">
                            <p>Your User ID (for app data association): <span className="font-mono break-all">{userId}</span></p>
                        </div>
                    </div>
                );
            case 'syllabus':
                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">RBI Grade B Syllabus</h2>
                        <p className="text-lg text-gray-700 text-center mb-8">
                            Explore the detailed syllabus, organized by phase, subject, and topic. Mark chapters as finished to track your progress.
                        </p>

                        <div className="space-y-6">
                            {Object.keys(rbiSyllabus).map(phaseKey => {
                                const phase = rbiSyllabus[phaseKey];
                                const isPhaseExpanded = expandedItems[`syllabus-${phaseKey}`];
                                return (
                                    <div key={phaseKey} className="border border-gray-200 rounded-xl overflow-hidden shadow-md">
                                        <button
                                            onClick={() => toggleSyllabusPhase(phaseKey)}
                                            className={`w-full text-left p-5 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 transition-colors flex justify-between items-center text-xl font-bold text-gray-800
                                                        ${phaseKey === "Phase I" ? "border-l-4 border-blue-500" : phaseKey === "Phase II" ? "border-l-4 border-green-500" : "border-l-4 border-indigo-500"}`}
                                        >
                                            {phase.title}
                                            {isPhaseExpanded ? <ChevronDown size={24} /> : <ChevronRight size={24} />}
                                        </button>
                                        <div className={`transition-all duration-300 ease-in-out ${isPhaseExpanded ? 'max-h-[9999px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                                            <div className="p-4 space-y-4">
                                                {phase.sections.map(section => {
                                                    const isSubjectExpanded = expandedItems[`syllabus-${phaseKey}-${section.name}`];
                                                    return (
                                                        <div key={section.name} className="border border-gray-100 rounded-lg overflow-hidden shadow-sm">
                                                            <button
                                                                onClick={() => toggleSyllabusSubject(phaseKey, section.name)}
                                                                className="w-full text-left p-4 bg-white hover:bg-gray-50 transition-colors flex justify-between items-center text-lg font-semibold text-gray-700"
                                                            >
                                                                {section.name}
                                                                {isSubjectExpanded ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                                            </button>
                                                            <div className={`transition-all duration-300 ease-in-out ${isSubjectExpanded ? 'max-h-[9999px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                                                                <ul className="list-disc list-inside ml-8 p-4 bg-gray-50 text-gray-600 overflow-y-auto">
                                                                    {section.topics.length > 0 ? (
                                                                        section.topics.map((chapterName, idx) => {
                                                                            const chapterIdentifier = `${phaseKey}___${section.name}___${chapterName}`;
                                                                            const currentStatus = chapterProgress[chapterIdentifier] || { readNotes: false, takenTest: false };
                                                                            return (
                                                                                <li key={idx} className="mb-1 flex items-center justify-between py-1">
                                                                                    <span className="flex-grow text-gray-700">{chapterName}</span>
                                                                                    <div className="flex items-center ml-4 space-x-4">
                                                                                        <label className="flex items-center cursor-pointer text-sm text-gray-600">
                                                                                            <input
                                                                                                type="checkbox"
                                                                                                className="form-checkbox h-4 w-4 text-green-600 rounded"
                                                                                                checked={currentStatus.readNotes}
                                                                                                onChange={() => handleToggleChapterProgress(phaseKey, section.name, chapterName, 'readNotes')}
                                                                                            />
                                                                                            <span className="ml-2">Read Notes</span>
                                                                                        </label>
                                                                                        <label className="flex items-center cursor-pointer text-sm text-gray-600">
                                                                                            <input
                                                                                                type="checkbox"
                                                                                                className="form-checkbox h-4 w-4 text-purple-600 rounded"
                                                                                                checked={currentStatus.takenTest}
                                                                                                onChange={() => handleToggleChapterProgress(phaseKey, section.name, chapterName, 'takenTest')}
                                                                                            />
                                                                                            <span className="ml-2">Take Test</span>
                                                                                        </label>
                                                                                    </div>
                                                                                </li>
                                                                            );
                                                                        })
                                                                    ) : (
                                                                        <p className="italic">No detailed topics available for this subject.</p>
                                                                    )}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );

            case 'study-plan':
                if (!selectedPlan) {
                    return (
                        <div className="p-6 text-center text-gray-600">
                            <p>No study plan selected. Please go back to "My Study Plans" and select one.</p>
                            <button
                                onClick={() => setCurrentPage('study-plan')}
                                className="mt-4 px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300"
                            >
                                Back to Study Plans
                            </button>
                        </div>
                    );
                }
                const currentSelectedPlan = studyPlans.find(plan => plan.id === selectedPlan.id);
                const completedTasks = currentSelectedPlan?.tasks ? currentSelectedPlan.tasks.filter(task => task.completed).length : 0;
                const totalTasks = currentSelectedPlan?.tasks ? currentSelectedPlan.tasks.length : 0;
                const progressPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;

                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Study Plan: {currentSelectedPlan.name}</h2>
                        <button
                            onClick={() => setCurrentPage('study-plan')}
                            className="mb-4 px-4 py-2 bg-gray-500 text-white text-sm font-semibold rounded-lg hover:bg-gray-600 transition duration-300"
                        >
                            ← Back to All Plans
                        </button>

                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-6">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-blue-500">Plan Details</h3>
                            <p className="text-gray-700">Created: {new Date(currentSelectedPlan.createdAt).toLocaleString()}</p>

                            <div className="mt-4 mb-4">
                                <h4 className="text-xl font-semibold text-gray-700 mb-2">Progress: {completedTasks}/{totalTasks} tasks completed</h4>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                    <div
                                        className="bg-blue-600 h-2.5 rounded-full"
                                        style={{ width: `${progressPercentage}%` }}
                                    ></div>
                                </div>
                                <p className="text-sm text-gray-600 mt-1">{progressPercentage.toFixed(0)}% Complete</p>
                            </div>

                            <div className="mt-6">
                                <h4 className="text-xl font-semibold text-gray-700 mb-3 border-l-4 pl-3 border-blue-500">Add New Task</h4>
                                <div className="flex flex-col sm:flex-row gap-4 mb-4">
                                    <input
                                        type="text"
                                        placeholder="Describe your task (e.g., 'Read Economic Survey Chapter 3')"
                                        className="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                        value={newTaskContent}
                                        onChange={(e) => setNewTaskContent(e.target.value)}
                                    />
                                    <button
                                        onClick={handleAddTask}
                                        className="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                                    >
                                        Add Task
                                    </button>
                                </div>
                            </div>

                            <div className="mt-6">
                                <h4 className="text-xl font-semibold text-gray-700 mb-3 border-l-4 pl-3 border-blue-500">Tasks</h4>
                                {currentSelectedPlan.tasks && currentSelectedPlan.tasks.length > 0 ? (
                                    <ul className="space-y-3">
                                        {currentSelectedPlan.tasks.map(task => (
                                            <li key={task.id} className={`p-4 rounded-lg shadow-sm flex items-center justify-between ${task.completed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                                                <div className="flex items-center flex-grow">
                                                    <input
                                                        type="checkbox"
                                                        checked={task.completed}
                                                        onChange={() => handleToggleTaskComplete(currentSelectedPlan.id, task)}
                                                        className="form-checkbox h-5 w-5 text-green-600 rounded"
                                                    />
                                                    <span className={`ml-3 text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                        {task.content}
                                                    </span>
                                                </div>
                                                <button
                                                    onClick={() => handleDeleteTask(currentSelectedPlan.id, task)}
                                                    className="ml-4 p-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-300"
                                                >
                                                    Delete
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (
                                    <p className="text-gray-600">No tasks added to this plan yet.</p>
                                )}
                            </div>

                            <button
                                onClick={() => enhanceStudyPlan(currentSelectedPlan)}
                                disabled={planEnhancementLoading}
                                className="mt-8 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {planEnhancementLoading ? 'Generating Suggestions...' : '✨ Enhance Study Plan'}
                            </button>
                            {planEnhancementFeedback && (
                                <div className="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200 text-gray-800">
                                    <h3 className="font-semibold text-purple-800 mb-2">Enhancement Suggestions:</h3>
                                    <p className="whitespace-pre-wrap">{planEnhancementFeedback}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            case 'quiz':
                const getQuizPhaseDisplayName = (phaseKey) => rbiSyllabus[phaseKey]?.title || phaseKey;

                // Function to extract chapter number for sorting (reused from notes)
                const extractChapterNum = (chapterName) => {
                    const match = chapterName.match(/^Chapter (\d+)([A-Z])?:\s/);
                    if (match) {
                        let num = parseInt(match[1]);
                        if (match[2]) {
                            num += (match[2].charCodeAt(0) - 'A'.charCodeAt(0) + 1) * 0.1;
                        }
                        return num;
                    }
                    return Infinity; // Send non-chapter names to the end
                };

                const renderQuizContent = () => {
                    switch (quizViewLevel) {
                        case 'phases':
                            const availableQuizPhases = Object.keys(rbiSyllabus).sort((a, b) => {
                                if (a === 'Uncategorized Phase') return 1;
                                if (b === 'Uncategorized Phase') return -1;
                                return a.localeCompare(b);
                            });
                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-teal-500">Select Phase for Quiz</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {availableQuizPhases.map(phaseKey => (
                                            <div
                                                key={phaseKey}
                                                className="relative bg-gradient-to-br from-teal-50 to-teal-100 p-6 rounded-xl shadow-md border border-teal-200 cursor-pointer hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
                                                onClick={() => {
                                                    setCurrentQuizPhase(phaseKey);
                                                    setQuizViewLevel('subjects');
                                                }}
                                            >
                                                <Layers className="text-teal-600 mb-3" size={32} />
                                                <h4 className="text-xl font-bold text-gray-800 mb-2">
                                                    {getQuizPhaseDisplayName(phaseKey)}
                                                </h4>
                                                <p className="text-sm text-gray-600">
                                                    Practice MCQs from this phase.
                                                </p>
                                                <ChevronRight size={20} className="absolute top-6 right-6 text-gray-500" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );

                        case 'subjects':
                            const allQuizSubjectsForPhase = rbiSyllabus[currentQuizPhase]?.sections || [];
                            const sortedAllQuizSubjects = [...allQuizSubjectsForPhase].sort((a,b) => a.name.localeCompare(b.name));

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setQuizViewLevel('phases');
                                                setCurrentQuizPhase(null);
                                                // Clear quiz state when going back to subjects
                                                setQuizQuestion('');
                                                setQuizOptions([]);
                                                setQuizAnswer('');
                                                setSelectedQuizOption('');
                                                setQuizFeedback('');
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Phases
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-teal-500">
                                            Select Subject in {getQuizPhaseDisplayName(currentQuizPhase)}
                                        </h3>
                                    </div>

                                    {sortedAllQuizSubjects.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No subjects defined for this phase.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {sortedAllQuizSubjects.map(section => (
                                                <div
                                                    key={section.name}
                                                    className="relative bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl shadow-md border border-yellow-200 cursor-pointer hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
                                                    onClick={() => {
                                                        setCurrentQuizSubject(section.name);
                                                        setQuizViewLevel('chapters');
                                                    }}
                                                >
                                                    <BookOpen className="text-yellow-600 mb-3" size={32} />
                                                    <h4 className="text-xl font-bold text-gray-800 mb-2">
                                                        {section.name}
                                                    </h4>
                                                    <p className="text-sm text-gray-600">
                                                        Select to practice chapter-wise MCQs.
                                                    </p>
                                                    <ChevronRight size={20} className="absolute top-6 right-6 text-gray-500" />
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );

                        case 'chapters':
                            const syllabusQuizChapters = rbiSyllabus[currentQuizPhase]?.sections.find(
                                s => s.name === currentQuizSubject
                            )?.topics || [];

                            const sortedQuizChapters = [...syllabusQuizChapters].sort((a, b) => {
                                if (currentQuizSubject === "General Awareness" && a.match(/^\d{4}-\d{2}-\d{2}$/) && b.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                    return b.localeCompare(a); // Sort dates descending
                                }
                                const numA = extractChapterNum(a);
                                const numB = extractChapterNum(b);

                                if (numA === Infinity && numB === Infinity) return a.localeCompare(b);
                                if (numA === Infinity) return 1;
                                if (numB === Infinity) return -1;
                                return numA - numB;
                            });

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setQuizViewLevel('subjects');
                                                setCurrentQuizSubject(null);
                                                // Clear quiz state when going back to subjects
                                                setQuizQuestion('');
                                                setQuizOptions([]);
                                                setQuizAnswer('');
                                                setSelectedQuizOption('');
                                                setQuizFeedback('');
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Subjects
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-teal-500">
                                            Chapters in {currentQuizSubject} ({getQuizPhaseDisplayName(currentQuizPhase)})
                                        </h3>
                                    </div>

                                    {sortedQuizChapters.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No chapters found for this subject.</p>
                                    ) : (
                                        <div className="flex flex-col space-y-4"> {/* Vertical arrangement */}
                                            {sortedQuizChapters.map(chapterName => {
                                                const displayChapterName = chapterName.match(/^\d{4}-\d{2}-\d{2}$/)
                                                    ? new Date(chapterName).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })
                                                    : chapterName;
                                                return (
                                                    <div
                                                        key={chapterName}
                                                        className="relative bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl shadow-sm border border-blue-200 flex items-center justify-between"
                                                    >
                                                        <div className="flex items-center">
                                                            <ListTodo className="text-blue-600 mr-3" size={24} />
                                                            <h4 className="text-lg font-semibold text-gray-800 flex-grow">{displayChapterName}</h4>
                                                        </div>
                                                        <button
                                                            onClick={() => {
                                                                setCurrentQuizChapter(chapterName);
                                                                setQuizViewLevel('quizForm');
                                                                generateQuizQuestion(currentQuizPhase, currentQuizSubject, chapterName);
                                                            }}
                                                            disabled={llmLoading}
                                                            className="px-4 py-2 bg-teal-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                                        >
                                                            {llmLoading ? 'Generating...' : 'Generate Question'}
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );

                        case 'quizForm':
                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setQuizViewLevel('chapters');
                                                // Clear quiz state when going back
                                                setQuizQuestion('');
                                                setQuizOptions([]);
                                                setQuizAnswer('');
                                                setSelectedQuizOption('');
                                                setQuizFeedback('');
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Chapters
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-teal-500">
                                            MCQ Practice: {currentQuizChapter && currentQuizChapter.match(/^\d{4}-\d{2}-\d{2}$/) ? new Date(currentQuizChapter).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }) : currentQuizChapter}
                                        </h3>
                                    </div>
                                    <p className="text-sm text-gray-600 mb-4">
                                        Phase: {getQuizPhaseDisplayName(currentQuizPhase)} &bull; Subject: {currentQuizSubject}
                                    </p>

                                    <button
                                        onClick={() => generateQuizQuestion(currentQuizPhase, currentQuizSubject, currentQuizChapter)}
                                        disabled={llmLoading}
                                        className="mb-6 px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {llmLoading ? 'Generating...' : 'Generate New Question'}
                                    </button>

                                    {quizQuestion && (
                                        <div className="mt-8">
                                            <p className="text-lg font-medium text-gray-800 mb-4">{quizQuestion}</p>
                                            <div className="space-y-3">
                                                {quizOptions.map((option, index) => (
                                                    <label key={index} className="flex items-center p-3 bg-gray-50 rounded-lg shadow-sm cursor-pointer hover:bg-gray-100 transition duration-200">
                                                        <input
                                                            type="radio"
                                                            name="quizOption"
                                                            value={option}
                                                            checked={selectedQuizOption === option}
                                                            onChange={(e) => {
                                                                setSelectedQuizOption(e.target.value);
                                                                setQuizFeedback('');
                                                            }}
                                                            className="form-radio h-5 w-5 text-blue-600"
                                                        />
                                                        <span className="ml-3 text-gray-700">{option}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            <button
                                                onClick={submitQuizAnswer}
                                                className="mt-6 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                                            >
                                                Submit Answer
                                            </button>
                                            {quizFeedback && (
                                                <p className={`mt-4 text-lg font-semibold ${quizFeedback.startsWith('Correct') ? 'text-green-600' : 'text-red-600'}`}>
                                                    {quizFeedback}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        default:
                            return null;
                    }
                };

                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">MCQ & PYQ Practice</h2>
                        {renderQuizContent()}
                    </div>
                );
            case 'performance':
                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Performance Analysis</h2>
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-gray-500">Quiz History</h3>
                            {quizResults.length === 0 ? (
                                <p className="text-gray-600">No quiz attempts recorded yet. Take a quiz!</p>
                            ) : (
                                <ul className="space-y-3 max-h-96 overflow-y-auto">
                                    {quizResults.map(result => (
                                        <li key={result.id} className={`p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center ${result.isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                                            <div className="flex-grow">
                                                <p className="text-lg font-medium text-gray-800">
                                                    <span className="font-semibold">{result.subject} {result.chapter ? `(${result.chapter})` : ''}:</span> {result.question}
                                                </p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    Your Answer: <span className="font-semibold">{result.selectedOption}</span>
                                                </p>
                                                <p className="text-sm text-gray-600">
                                                    Correct Answer: <span className="font-semibold">{result.correctAnswer}</span>
                                                </p>
                                                {result.explanation && (
                                                    <p className="text-xs text-gray-700 mt-2">
                                                        **Explanation:** {result.explanation}
                                                    </p>
                                                )}
                                            </div>
                                            <div className="flex-shrink-0 mt-2 sm:mt-0 sm:ml-4 text-right">
                                                <p className={`text-lg font-bold ${result.isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                                                    {result.isCorrect ? 'Correct' : 'Incorrect'}
                                                </p>
                                                <p className="text-xs text-gray-500">{new Date(result.date).toLocaleString()}</p>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        <div className="mt-6 p-4 bg-gray-100 rounded-lg text-gray-600 italic">
                            Future enhancement: Visual charts and metrics for performance trends.
                        </div>
                    </div>
                );
            case 'ai-expert':
                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Ask the AI Coach</h2>
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-purple-500">Ask Question</h3>
                            <p className="text-gray-700 mb-4">
                                Ask any question related to RBI Grade B syllabus, concepts, or general preparation.
                                The AI will do its best to provide a helpful answer.
                            </p>
                            <textarea
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                rows="5"
                                placeholder="E.g., 'Explain the concept of Financial Inclusion.', 'What are the key differences between monetary and fiscal policy?'"
                                value={llmQuestion}
                                onChange={(e) => setLlmQuestion(e.target.value)}
                            ></textarea>
                            <button
                                onClick={askLlmExpert}
                                disabled={llmLoading}
                                className="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {llmLoading ? 'Thinking...' : 'Ask Question'}
                            </button>
                            {llmAnswer && (
                                <div className="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200 text-gray-800">
                                    <h3 className="font-semibold text-purple-800 mb-2">Answer:</h3>
                                    <p className="whitespace-pre-wrap">{llmAnswer}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            case 'essay-evaluator':
                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Essay/Precis Evaluator</h2>
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-orange-500">Get Feedback</h3>
                            <p className="text-gray-700 mb-4">
                                Paste your essay or precis below and get AI-powered feedback on grammar, coherence, vocabulary, and conciseness for your English Writing Skills paper.
                            </p>
                            <textarea
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-orange-400"
                                rows="10"
                                placeholder="Paste your essay or precis here..."
                                value={essayInput}
                                onChange={(e) => setEssayInput(e.target.value)}
                            ></textarea>
                            <button
                                onClick={getEssayFeedback}
                                disabled={essayLoading}
                                className="px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {essayLoading ? 'Analyzing...' : '✨ Get Feedback'}
                            </button>
                            {essayFeedback && (
                                <div className="mt-6 p-4 bg-orange-50 rounded-lg border border-orange-200 text-gray-800">
                                    <h3 className="font-semibold text-orange-800 mb-2">Feedback:</h3>
                                    <p className="whitespace-pre-wrap">{essayFeedback}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            case 'resources':
                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Recommended Resources</h2>
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-gray-500">Books & Study Materials</h3>
                            <ul className="list-disc list-inside space-y-2 text-gray-700 mb-8">
                                <li>**General Awareness:** Lucent's General Knowledge, Current Affairs Magazines (e.g., "The Hindu," "The Economic Times")</li>
                                <li>**English Language:** "Word Power Made Easy" by Norman Lewis, "High School English Grammar and Composition" by Wren and Martin</li>
                                <li>**Quantitative Aptitude:** "Quantitative Aptitude for Competitive Examinations" by R.S. Aggarwal, "Magical Book on Quicker Maths" by M. Tyra</li>
                                <li>**Reasoning Ability:** "A Modern Approach to Verbal & Non-Verbal Reasoning" by R.S. Aggarwal, "Analytical Reasoning" by M.K. Pandey</li>
                                <li>**Economic and Social Issues (ESI):** "Indian Economy" by Ramesh Singh, Economic Survey, Union Budget, NITI Aayog Reports</li>
                                <li>**Finance and Management (FM):** "Indian Financial System" by Bharati V. Pathak, "Fundamentals of Financial Management" by Prasanna Chandra, "Organizational Behaviour" by Stephen P. Robbins</li>
                            </ul>

                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-gray-500">Previous Year Question Papers</h3>
                            <p className="text-gray-700 mb-4">
                                Practicing previous year papers is crucial. Here are some years for which papers are commonly available:
                            </p>
                            <ul className="list-disc list-inside space-y-2 text-blue-700">
                                <li><a href="https://www.adda247.com/jobs/rbi-grade-b-previous-year-question-papers/" target="_blank" rel="noopener noreferrer" className="hover:underline">RBI Grade B Previous Year Papers (Adda247)</a></li>
                                <li><a href="https://cracku.in/rbi-grade-b-previous-papers" target="_blank" rel="noopener noreferrer" className="hover:underline">RBI Grade B Previous Year Question Papers (Cracku)</a></li>
                                <li>Search online for specific years like "RBI Grade B 2024 Question Paper PDF"</li>
                            </ul>
                        </div>
                    </div>
                );
            case 'notes':
                // Group notes by Phase -> Subject -> Chapter for hierarchical display
                const organizedNotesHierarchical = notes.reduce((acc, note) => {
                    const phaseKey = note.phase || 'Uncategorized Phase';
                    const subjectKey = note.subject || 'Uncategorized Subject';
                    const chapterKey = (note.subject === "General Awareness" && note.chapter && note.chapter.match(/^\d{4}-\d{2}-\d{2}$/))
                                       ? note.chapter // Use date as chapter key for CA
                                       : (note.chapter || 'Uncategorized Chapter');

                    if (!acc[phaseKey]) acc[phaseKey] = {};
                    if (!acc[phaseKey][subjectKey]) acc[phaseKey][subjectKey] = {};
                    if (!acc[phaseKey][subjectKey][chapterKey]) acc[phaseKey][subjectKey][chapterKey] = [];
                    acc[phaseKey][subjectKey][chapterKey].push(note);
                    return acc;
                }, {});

                const getPhaseDisplayName = (phaseKey) => rbiSyllabus[phaseKey]?.title || phaseKey;

                // Render notes based on `noteViewLevel`
                const renderNotesContent = () => {
                    switch (noteViewLevel) {
                        case 'phases':
                            const availablePhases = Object.keys(organizedNotesHierarchical).sort((a, b) => {
                                if (a === 'Uncategorized Phase') return 1;
                                if (b === 'Uncategorized Phase') return -1;
                                return a.localeCompare(b);
                            });

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-blue-500">Browse Notes by Phase</h3>
                                    {availablePhases.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No notes available. Start by navigating to a chapter and adding one!</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {availablePhases.map(phaseKey => (
                                                <div
                                                    key={phaseKey}
                                                    className="relative bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-md border border-blue-200 cursor-pointer hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
                                                    onClick={() => {
                                                        setCurrentNotePhase(phaseKey);
                                                        setNoteViewLevel('subjects');
                                                    }}
                                                >
                                                    <Layers className="text-blue-500 mb-3" size={32} />
                                                    <h4 className="text-xl font-bold text-gray-800 mb-2">
                                                        {getPhaseDisplayName(phaseKey)}
                                                    </h4>
                                                    <p className="text-sm text-gray-600">
                                                        Contains notes for {Object.keys(organizedNotesHierarchical[phaseKey]).length} subjects.
                                                    </p>
                                                    <ChevronRight size={20} className="absolute top-6 right-6 text-gray-500" />
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );

                        case 'subjects':
                            // Get all subjects for the current phase from rbiSyllabus, not just those with notes
                            const allSubjectsForPhase = rbiSyllabus[currentNotePhase]?.sections || [];
                            const sortedAllSubjects = [...allSubjectsForPhase].sort((a,b) => a.name.localeCompare(b.name));

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setNoteViewLevel('phases');
                                                setCurrentNotePhase(null);
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Subjects
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-blue-500">
                                            Subjects in {getPhaseDisplayName(currentNotePhase)}
                                        </h3>
                                    </div>

                                    {sortedAllSubjects.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No subjects defined for this phase in the syllabus.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                            {sortedAllSubjects.map(section => {
                                                const notesCountForSubject = Object.values(organizedNotesHierarchical[currentNotePhase]?.[section.name] || {}).flat().length;
                                                return (
                                                    <div
                                                        key={section.name}
                                                        className="relative bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-md border border-green-200 cursor-pointer hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300"
                                                        onClick={() => {
                                                            setCurrentNoteSubject(section.name);
                                                            setNoteViewLevel('chapters');
                                                        }}
                                                    >
                                                        <BookOpen className="text-green-600 mb-3" size={32} />
                                                        <h4 className="text-xl font-bold text-gray-800 mb-2">
                                                            {section.name}
                                                        </h4>
                                                        <p className="text-sm text-gray-600">
                                                            {notesCountForSubject} notes across {section.topics.length} chapters.
                                                        </p>
                                                        <ChevronRight size={20} className="absolute top-6 right-6 text-gray-500" />
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );

                        case 'chapters':
                            // Get the full list of chapters from rbiSyllabus for the current subject
                            const syllabusChapters = rbiSyllabus[currentNotePhase]?.sections.find(
                                s => s.name === currentNoteSubject
                            )?.topics || [];

                            const notesForCurrentSubjectChapters = (organizedNotesHierarchical[currentNotePhase] && organizedNotesHierarchical[currentNotePhase][currentNoteSubject]) || {};

                            const sortedSyllabusChapters = [...syllabusChapters].sort((a, b) => {
                                // Function to extract chapter number for sorting
                                const extractChapterNum = (chapterName) => {
                                    const match = chapterName.match(/^Chapter (\d+)([A-Z])?:\s/);
                                    if (match) {
                                        let num = parseInt(match[1]);
                                        if (match[2]) {
                                            // Convert A, B, C to decimals for sub-chapters (e.g., 2A = 2.1, 2B = 2.2)
                                            num += (match[2].charCodeAt(0) - 'A'.charCodeAt(0) + 1) * 0.1;
                                        }
                                        return num;
                                    }
                                    return Infinity; // Send non-chapter names to the end
                                };

                                const numA = extractChapterNum(a);
                                const numB = extractChapterNum(b);

                                if (numA === Infinity && numB === Infinity) {
                                    // Both are non-chapter names, sort alphabetically
                                    return a.localeCompare(b);
                                }
                                if (numA === Infinity) return 1; // a is non-chapter, send to end
                                if (numB === Infinity) return -1; // b is non-chapter, send to end

                                return numA - numB; // Sort numerically
                            });

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setNoteViewLevel('subjects');
                                                setCurrentNoteSubject(null);
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Subjects
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-blue-500">
                                            Chapters in {currentNoteSubject} ({getPhaseDisplayName(currentNotePhase)})
                                        </h3>
                                    </div>

                                    {sortedSyllabusChapters.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No chapters found for this subject. Add a note to begin!</p>
                                    ) : (
                                        // Changed grid to vertical layout
                                        <div className="flex flex-col space-y-4">
                                            {sortedSyllabusChapters.map(chapterName => {
                                                const displayChapterName = chapterName.match(/^\d{4}-\d{2}-\d{2}$/)
                                                    ? new Date(chapterName).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })
                                                    : chapterName;
                                                const notesCount = (notesForCurrentSubjectChapters[chapterName] ? notesForCurrentSubjectChapters[chapterName].length : 0);

                                                return (
                                                    <div
                                                        key={chapterName}
                                                        className="relative bg-gradient-to-br from-yellow-50 to-yellow-100 p-5 rounded-xl shadow-sm border border-yellow-200 flex items-center justify-between"
                                                    >
                                                        <div className="flex items-center">
                                                            <ListTodo className="text-yellow-600 mr-3" size={24} />
                                                            <div>
                                                                <h4 className="text-lg font-semibold text-gray-800">{displayChapterName}</h4>
                                                                <p className="text-sm text-gray-600">{notesCount} notes</p>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation(); // Prevent card click from propagating
                                                                    setSelectedNotePhase(currentNotePhase);
                                                                    setSelectedNoteSubject(currentNoteSubject);
                                                                    setSelectedNoteChapter(chapterName);
                                                                    setNoteTitle(''); // Clear title for new note
                                                                    setNewNoteContent(''); // Clear content for new note
                                                                    setSelectedFile(null); // Clear file for new note
                                                                    setCurrentAffairsDateInput(''); // Clear CA date
                                                                    setShowAddNoteModal(true);
                                                                }}
                                                                className="px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-300"
                                                                title={`Add Note for ${displayChapterName}`}
                                                            >
                                                                Add Note
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation(); // Prevent card click from propagating
                                                                    setCurrentNoteChapter(chapterName);
                                                                    setNoteViewLevel('notesList');
                                                                }}
                                                                className="px-4 py-2 bg-yellow-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-yellow-700 transition duration-300"
                                                                title={`View Notes for ${displayChapterName}`}
                                                            >
                                                                View Notes
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation(); // Prevent card click from propagating
                                                                    handleGenerateChapterTest(chapterName);
                                                                }}
                                                                disabled={notesCount === 0 || isTestLoading}
                                                                className="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                                                title={`Generate Test from Notes for ${displayChapterName}`}
                                                            >
                                                                {isTestLoading ? 'Generating...' : 'Take Test'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );

                        case 'notesList':
                            const notesForChapter = (organizedNotesHierarchical[currentNotePhase] &&
                                                    organizedNotesHierarchical[currentNotePhase][currentNoteSubject] &&
                                                    organizedNotesHierarchical[currentNotePhase][currentNoteSubject][currentNoteChapter]) || [];

                            return (
                                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <button
                                            onClick={() => {
                                                setNoteViewLevel('chapters');
                                                setCurrentNoteChapter(null);
                                            }}
                                            className="mr-3 px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition-colors"
                                        >
                                            ← Back to Chapters
                                        </button>
                                        <h3 className="text-2xl font-semibold text-gray-700 border-l-4 pl-3 border-blue-500">
                                            Notes for {currentNoteChapter.match(/^\d{4}-\d{2}-\d{2}$/) ? new Date(currentNoteChapter).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }) : currentNoteChapter}
                                        </h3>
                                    </div>

                                    <div className="mb-6">
                                        <input
                                            type="text"
                                            placeholder="Search notes in this chapter..."
                                            className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 w-full"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>

                                    {notesForChapter.length === 0 ? (
                                        <p className="text-gray-600 text-center py-8">No notes found for this chapter. Add one!</p>
                                    ) : (
                                        <ul className="space-y-3 max-h-96 overflow-y-auto">
                                            {notesForChapter
                                                .filter(note => searchTerm === '' || note.title.toLowerCase().includes(searchTerm.toLowerCase()) || (note.content && note.content.toLowerCase().includes(searchTerm.toLowerCase())))
                                                .map(note => (
                                                    <li
                                                        key={note.id}
                                                        onClick={() => { setCurrentViewingNote(note); setShowNoteModal(true); }}
                                                        className="p-4 bg-white rounded-lg shadow-sm border border-gray-100 cursor-pointer hover:bg-blue-50 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center"
                                                    >
                                                            <div className="flex-grow flex items-center">
                                                                {note.uploadedFile ? <File size={18} className="text-gray-500 mr-2" /> : <FileText size={18} className="text-blue-500 mr-2" />}
                                                                <p className="font-semibold text-gray-800">{note.title}</p>
                                                            </div>
                                                            <div className="flex-shrink-0 mt-2 sm:mt-0 sm:ml-4 text-right">
                                                                <p className="text-xs text-gray-500">{new Date(note.createdAt).toLocaleDateString()}</p>
                                                            </div>
                                                        </li>
                                                    ))}
                                            </ul>
                                        )}
                                    </div>
                                );
                        default:
                            return null;
                    }
                };

                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Smart Notes Vault</h2>
                        {showStorageRulesMessage && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4" role="alert">
                                <strong className="font-bold">Permission Error!</strong>
                                <span className="block sm:inline ml-2">To upload files, you need to update your Firebase Storage security rules. Please check the instructions provided in the chat.</span>
                                <button
                                    onClick={() => setShowStorageRulesMessage(false)}
                                    className="ml-4 float-right text-red-700 hover:text-red-900 font-bold"
                                >
                                    &times;
                                </button>
                            </div>
                        )}
                        {renderNotesContent()}
                        {showAddNoteModal && (
                            <AddNoteModal onClose={() => setShowAddNoteModal(false)} />
                        )}
                    </div>
                );
            case 'daily-financial-news':
                const groupedNews = dailyNews.reduce((acc, newsItem) => {
                    const date = new Date(newsItem.date);
                    const year = date.getFullYear().toString();
                    const monthKey = `${year}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    const dayKey = newsItem.date;

                    if (!acc[year]) acc[year] = {};
                    if (!acc[year][monthKey]) acc[year][monthKey] = {};
                    if (!acc[year][monthKey][dayKey]) acc[year][monthKey][dayKey] = [];
                    
                    acc[year][monthKey][dayKey].push(newsItem);
                    return acc;
                }, {});

                const currentMonth = new Date();
                const startMonth = new Date(2025, 5, 1);
                const monthsToDisplay = [];
                let tempMonth = new Date(startMonth);
                while (tempMonth <= new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1)) {
                    const year = tempMonth.getFullYear().toString();
                    const month = (tempMonth.getMonth() + 1).toString().padStart(2, '0');
                    monthsToDisplay.push(`${year}-${month}`);
                    tempMonth.setMonth(tempMonth.getMonth() + 1);
                }
                monthsToDisplay.reverse();

                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Daily Financial News</h2>
                        <p className="text-lg text-gray-700 text-center mb-8">
                            Track and review daily financial news summaries, organized by date and relevant RBI Grade B syllabus topics.
                        </p>

                        <div className="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-orange-500">Add New News Entry</h3>
                            <button
                                onClick={() => setShowAddNewsModal(true)}
                                className="px-6 py-3 bg-orange-600 text-white font-semibold rounded-lg shadow-md hover:bg-orange-700 transition duration-300 transform hover:scale-105"
                            >
                                + Add News for a Day
                            </button>
                        </div>

                        {showAddNewsModal && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                                    <button onClick={() => setShowAddNewsModal(false)} className="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                                        <X size={24} />
                                    </button>
                                    <h3 className="text-2xl font-bold text-gray-800 mb-4">Add Daily Financial News Summary</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label htmlFor="newsDate" className="block text-gray-700 text-lg font-medium mb-2">Date <span className="text-red-500">*</span>:</label>
                                            <input
                                                type="date"
                                                id="newsDate"
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                value={newNewsDate}
                                                onChange={(e) => setNewNewsDate(e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label htmlFor="newsSummary" className="block text-gray-700 text-lg font-medium mb-2">News Summary <span className="text-red-500">*</span>:</label>
                                            <textarea
                                                id="newsSummary"
                                                rows="5"
                                                placeholder="Enter a summary of the day's financial news (e.g., 'RBI increases repo rate by 25 bps. New fiscal policy announced...')"
                                                className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                value={newNewsSummary}
                                                onChange={(e) => setNewNewsSummary(e.target.value)}
                                            ></textarea>
                                        </div>

                                        <hr className="my-4 border-gray-200" />
                                        <h4 className="text-xl font-semibold text-gray-700 mb-2">Syllabus Mapping (Optional)</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div>
                                                <label htmlFor="newsPhase" className="block text-gray-700 text-lg font-medium mb-2">Phase:</label>
                                                <select
                                                    id="newsPhase"
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                    value={newsPhase}
                                                    onChange={(e) => {
                                                        setNewsPhase(e.target.value);
                                                        setNewNewsSubject('');
                                                        setNewNewsChapter('');
                                                    }}
                                                >
                                                    <option value="">-- Select Phase --</option>
                                                    {Object.keys(rbiSyllabus).map(phaseKey => (
                                                        <option key={phaseKey} value={phaseKey}>{rbiSyllabus[phaseKey].title}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label htmlFor="newsSubject" className="block text-gray-700 text-lg font-medium mb-2">Subject:</label>
                                                <select
                                                    id="newsSubject"
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                    value={newsSubject}
                                                    onChange={(e) => {
                                                        setNewNewsSubject(e.target.value);
                                                        setNewNewsChapter('');
                                                    }}
                                                    disabled={!newsPhase}
                                                >
                                                    <option value="">-- Select Subject --</option>
                                                    {newsPhase && rbiSyllabus[newsPhase]?.sections.map(section => (
                                                        <option key={section.name} value={section.name}>{section.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label htmlFor="newsChapter" className="block text-gray-700 text-lg font-medium mb-2">Chapter:</label>
                                                <select
                                                    id="newsChapter"
                                                    className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                                                    value={newsChapter}
                                                    onChange={(e) => setNewNewsChapter(e.target.value)}
                                                    disabled={!newsSubject}
                                                >
                                                    <option value="">-- Select Chapter --</option>
                                                    {newsSubject && newsPhase && rbiSyllabus[newsPhase]?.sections
                                                        .find(s => s.name === newsSubject)?.topics.map(topic => (
                                                            <option key={topic} value={topic}>{topic}</option>
                                                        ))
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-6 flex justify-end gap-3">
                                        <button
                                            onClick={() => setShowAddNewsModal(false)}
                                            className="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSaveDailyNews}
                                            disabled={!newNewsDate || !newNewsSummary.trim()}
                                            className="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Save News
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showNewsDetailModal && (
                            <NewsDetailModal newsItem={currentViewingNewsItem} onClose={() => setShowNewsDetailModal(false)} />
                        )}

                        <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-blue-500">News Timeline</h3>
                            {monthsToDisplay.length === 0 && Object.keys(groupedNews).length === 0 ? (
                                <p className="text-gray-600 text-center py-8">No news entries yet. Add your first news item!</p>
                            ) : (
                                <div className="space-y-6">
                                    {monthsToDisplay.map(monthKey => {
                                        const [year, monthNum] = monthKey.split('-');
                                        const monthName = new Date(parseInt(year), parseInt(monthNum) - 1, 1).toLocaleString('en-US', { month: 'long', year: 'numeric' });
                                        const isMonthExpanded = expandedItems[`news-month-${monthKey}`];
                                        const monthData = groupedNews[year] ? groupedNews[year][monthKey] : null;

                                        if (!monthData && new Date(monthKey + '-01') > new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1)) {
                                            return null;
                                        }

                                        return (
                                            <div key={monthKey} className="border border-gray-200 rounded-lg overflow-hidden">
                                                <button
                                                    onClick={() => toggleItem(`news-month-${monthKey}`)}
                                                    className="w-full text-left p-4 bg-gray-100 hover:bg-gray-200 transition-colors flex justify-between items-center text-lg font-semibold text-gray-700"
                                                >
                                                    {monthName}
                                                    {isMonthExpanded ? <ChevronDown size={20} /> : <ChevronRight size={20} />}
                                                </button>
                                                <div className={`transition-all duration-300 ease-in-out ${isMonthExpanded ? 'max-h-[9999px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                                                    <div className="p-4 space-y-4">
                                                        {monthData && Object.keys(monthData).sort((a,b) => b.localeCompare(a)).map(dayKey => {
                                                            const dayNews = monthData[dayKey];
                                                            const isDayExpanded = expandedItems[`news-day-${dayKey}`];
                                                            const dayFormatted = new Date(dayKey).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' });

                                                            return (
                                                                <div key={dayKey} className="border border-gray-100 rounded-lg overflow-hidden">
                                                                    <button
                                                                        onClick={() => toggleItem(`news-day-${dayKey}`)}
                                                                        className="w-full text-left p-3 bg-white hover:bg-gray-50 transition-colors flex justify-between items-center font-medium text-gray-600"
                                                                    >
                                                                        {dayFormatted} ({dayNews.length} news items)
                                                                        {isDayExpanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}
                                                                    </button>
                                                                    <div className={`transition-all duration-300 ease-in-out ${isDayExpanded ? 'max-h-[9999px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                                                                        <ul className="p-3 space-y-2">
                                                                            {dayNews.map(newsItem => (
                                                                                <li
                                                                                    key={newsItem.id}
                                                                                    onClick={() => { setCurrentViewingNewsItem(newsItem); setShowNewsDetailModal(true); }}
                                                                                    className="p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-50 cursor-pointer hover:bg-blue-50 transition-colors flex items-center"
                                                                                >
                                                                                    <div className="flex-grow flex items-center">
                                                                                        <FileText size={20} className="text-blue-500 mr-2" />
                                                                                        <p className="font-semibold text-gray-800">
                                                                                            {newsItem.summaryText ? `${newsItem.summaryText.substring(0, 50)}...` : 'News Summary'}
                                                                                        </p>
                                                                                    </div>
                                                                                    <p className="text-xs text-gray-500 ml-4">
                                                                                        {newsItem.phase && `Phase: ${rbiSyllabus[newsItem.phase]?.title || newsItem.phase}`}
                                                                                        {newsItem.subject && ` • Subject: ${newsItem.subject}`}
                                                                                        {newsItem.chapter && ` • Chapter: ${newsItem.chapter}`}
                                                                                    </p>
                                                                                </li>
                                                                            ))}
                                                                        </ul>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                );
            case 'take-test':
                const displayTestChapterName = currentTestChapter && currentTestChapter.match(/^\d{4}-\d{2}-\d{2}$/)
                    ? new Date(currentTestChapter).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' })
                    : currentTestChapter;

                return (
                    <div className="p-6">
                        <h2 className="text-3xl font-bold mb-6 text-gray-800 text-center">Take Test: {displayTestChapterName}</h2>
                        <button
                            onClick={() => {
                                setCurrentPage('notes');
                                setGeneratedTestQuestions([]);
                                setTestAnswers({});
                                setTestResults(null);
                            }}
                            className="mb-4 px-4 py-2 bg-gray-500 text-white text-sm font-semibold rounded-lg hover:bg-gray-600 transition duration-300"
                        >
                            ← Back to Notes
                        </button>

                        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <h3 className="text-2xl font-semibold text-gray-700 mb-4 border-l-4 pl-3 border-purple-500">Questions</h3>
                            {isTestLoading ? (
                                <p className="text-gray-600 text-center py-8">Generating questions, please wait...</p>
                            ) : generatedTestQuestions.length === 0 ? (
                                <p className="text-gray-600 text-center py-8">No questions generated. Please ensure notes are available for this chapter and try again.</p>
                            ) : (
                                <div className="space-y-8">
                                    {generatedTestQuestions.map((q, qIndex) => (
                                        <div key={qIndex} className="p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-100">
                                            <p className="text-lg font-medium text-gray-800 mb-3">{qIndex + 1}. {q.question}</p>
                                            <div className="space-y-2">
                                                {q.options.map((option, oIndex) => (
                                                    <label
                                                        key={oIndex}
                                                        className={`flex items-center p-2 rounded-md shadow-xs cursor-pointer transition duration-150
                                                                    ${testResults ?
                                                                        (testResults.details[qIndex].isCorrect && testResults.details[qIndex].correctAnswer === option
                                                                            ? 'bg-green-100' // Correct answer when submitted
                                                                            : (testAnswers[qIndex] === option && !testResults.details[qIndex].isCorrect
                                                                                ? 'bg-red-100' // User's incorrect answer
                                                                                : 'bg-white hover:bg-gray-100'))
                                                                        : 'bg-white hover:bg-gray-100' // Before submission
                                                                    }`}
                                                    >
                                                        <input
                                                            type="radio"
                                                            name={`question-${qIndex}`}
                                                            value={option}
                                                            checked={testAnswers[qIndex] === option}
                                                            onChange={() => handleTestOptionChange(qIndex, option)}
                                                            disabled={testResults !== null} // Disable after submission
                                                            className="form-radio h-4 w-4 text-purple-600"
                                                        />
                                                        <span className="ml-3 text-gray-700">{option}</span>
                                                    </label>
                                                ))}
                                            </div>
                                            {testResults && (
                                                <>
                                                    <p className={`mt-3 text-sm font-semibold ${testResults.details[qIndex].isCorrect ? 'text-green-600' : 'text-red-600'}`}>
                                                        Your Answer: {testAnswers[qIndex] || 'Not Answered'}
                                                    </p>
                                                    {!testResults.details[qIndex].isCorrect && (
                                                        <p className="mt-1 text-sm font-semibold text-green-600">
                                                            Correct Answer: {q.answer}
                                                        </p>
                                                    )}
                                                    {q.explanation && (
                                                        <p className="mt-2 text-sm text-gray-700">
                                                            **Explanation:** {q.explanation}
                                                        </p>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    ))}
                                    {!testResults && (
                                        <button
                                            onClick={submitTest}
                                            className="mt-6 px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105"
                                        >
                                            Submit Test
                                        </button>
                                    )}
                                    {testResults && (
                                        <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 text-gray-800">
                                            <h3 className="font-bold text-xl mb-2 text-blue-800">Test Results:</h3>
                                            <p className="text-lg">You scored: <span className="font-semibold">{testResults.score} / {testResults.total}</span></p>
                                            <p className="text-sm text-gray-600 mt-2">Review your answers above.</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            default:
                return null;
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 font-inter flex flex-col">
            {showMessage && (
                <div className="fixed top-4 right-4 bg-blue-600 text-white px-5 py-3 rounded-lg shadow-xl z-50 animate-fade-in-down">
                    {message}
                </div>
            )}

            {showNoteModal && (
                <NoteModal note={currentViewingNote} onClose={() => { setShowNoteModal(false); setCurrentViewingNote(null); }} />
            )}


            <nav className="bg-gradient-to-r from-indigo-700 to-blue-700 p-4 shadow-xl">
                <div className="container mx-auto flex flex-wrap justify-start items-center">
                    <div className="text-white text-2xl font-extrabold tracking-wide mb-2 sm:mb-0 mr-4">
                        RBI Grade B Success
                    </div>
                    <div className="flex flex-wrap flex-grow justify-start space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                        <NavButton text="Syllabus" onClick={() => setCurrentPage('syllabus')} active={currentPage === 'syllabus'} />
                        <NavButton text="Dashboard" onClick={() => setCurrentPage('dashboard')} active={currentPage === 'dashboard'} />
                        <NavButton text="Notes" onClick={() => { setCurrentPage('notes'); setNoteViewLevel('phases'); setCurrentNotePhase(null); setCurrentNoteSubject(null); setCurrentNoteChapter(null); setSearchTerm(''); }} active={currentPage === 'notes'} />
                        <NavButton text="Quiz" onClick={() => { setCurrentPage('quiz'); setQuizViewLevel('phases'); setCurrentQuizPhase(null); setCurrentQuizSubject(null); setCurrentQuizChapter(null); setQuizQuestion(''); setQuizOptions([]); setQuizAnswer(''); setSelectedQuizOption(''); setQuizFeedback(''); }} active={currentPage === 'quiz'} />
                        <NavButton text="Daily Financial News" onClick={() => setCurrentPage('daily-financial-news')} active={currentPage === 'daily-financial-news'} />
                    </div>
                </div>
            </nav>

            <main className="flex-grow container mx-auto my-8 p-4 bg-white rounded-xl shadow-2xl border border-gray-200">
                {renderPage()}
            </main>

            <footer className="bg-gray-800 text-white p-4 text-center text-sm">
                <div className="container mx-auto">
                    &copy; {new Date().getFullYear()} RBI Grade B Success App. All rights reserved.
                </div>
            </footer>
        </div>
    );
}

const NavButton = ({ text, onClick, active }) => (
    <button
        onClick={onClick}
        className={`px-4 py-2 rounded-lg text-sm font-medium transition duration-300 whitespace-nowrap
            ${active
                ? 'bg-blue-500 text-white shadow-lg border-l-4 border-white'
                : 'text-blue-100 hover:bg-blue-600 hover:text-white'
            }`}
    >
        {text}
    </button>
);

const DashboardCard = ({ icon, title, description, onClick, bgColor, borderColor, shadowColor }) => (
    <div
        className={`relative ${bgColor} p-6 rounded-xl shadow-lg hover:${shadowColor} hover:shadow-xl transition-all duration-300 ease-in-out
                   transform hover:-translate-y-1 cursor-pointer border ${borderColor} flex flex-col justify-between`}
        onClick={onClick}
    >
        <div>
            <div className="text-5xl mb-4 text-center">
                {icon}
            </div>
            <h3 className="text-xl font-bold text-gray-800 mb-2 text-center">{title}</h3>
            <p className="text-gray-600 text-sm text-center">{description}</p>
        </div>
        <div className="mt-4 text-center">
             <span className="text-blue-600 font-semibold text-sm">Explore →</span>
        </div>
    </div>
);

export default App;
